<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParamÃ¨tres - Newsly AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“°</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/css/styles.css">
    <link rel="stylesheet" href="public/css/floating-sidebar.css">
    <script src="public/js/browser-detect.js"></script>
</head>
<body class="dashboard-body">
    <!-- Particles.js Background -->
    <!-- DÃ‰SACTIVÃ‰ - Conflit avec Aurora et Dark/Light Mode
    <div id="particles-js"></div>
    -->

    <!-- Overlay pour menu mobile -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Navigation Top Bar -->
    <nav class="navbar dashboard-nav">
        <div class="nav-container">
            <!-- Bouton burger pour menu mobile (settings nav) -->
            <button class="mobile-menu-btn" id="mobileSettingsNavBtn" aria-label="Ouvrir menu paramÃ¨tres">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <a href="dashboard.html" class="logo">
                <img src="https://img.icons8.com/ios-filled/50/FFFFFF/news.png" alt="News" class="logo-icon icon-white" style="width: 1.75rem; height: 1.75rem;">
                <span class="logo-text">Newsly AI</span>
            </a>

            <div class="nav-user-weather">
                <!-- Weather Widget -->
                <div class="weather-widget" id="weatherWidget">
                    <div class="weather-loading">
                        <span>â˜ï¸</span>
                    </div>
                </div>
            </div>

            <div class="nav-links">
                <!-- Burger Menu -->
                <button class="burger-menu" id="burgerBtn">
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                </button>

                <!-- Burger Dropdown Menu -->
                <div class="burger-dropdown" id="burgerMenu">
                    <!-- User Info -->
                    <div class="burger-user-info">
                        <img id="burgerAvatarImage" class="burger-user-avatar" src="https://ui-avatars.com/api/?name=User&background=3ecf8e&color=fff&size=72" alt="Avatar">
                        <span id="userNameDisplay" class="burger-user-name">User: User</span>
                    </div>

                    <div class="burger-divider"></div>

                    <!-- Theme Toggle avec Switch -->
                    <div class="burger-item">
                        <div class="burger-item-label">
                            <img src="https://img.icons8.com/ios-filled/50/000000/moon-symbol.png" alt="Theme" class="icon-secondary" style="width: 1.5rem; height: 1.5rem;">
                            <span id="themeText" data-i18n="nav.darkMode">Mode sombre</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="themeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Language Toggle avec Switch -->
                    <div class="burger-item">
                        <div class="burger-item-label">
                            <img src="https://img.icons8.com/ios-filled/50/000000/globe.png" alt="Language" class="icon-secondary" style="width: 1.5rem; height: 1.5rem;">
                            <span id="langLabel">FranÃ§ais / English</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="langToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="burger-divider"></div>

                    <button class="burger-link" id="dashboardBtn">
                        <img src="https://img.icons8.com/ios-filled/50/000000/dashboard.png" alt="Dashboard" class="icon-secondary" style="width: 1.5rem; height: 1.5rem;">
                        <span data-i18n="nav.dashboard">Dashboard</span>
                    </button>

                    <button class="burger-link" id="logoutBtn">
                        <img src="https://img.icons8.com/ios-filled/50/000000/exit.png" alt="Logout" class="icon-secondary" style="width: 1.5rem; height: 1.5rem;">
                        <span data-i18n="nav.logout">DÃ©connexion</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Floating Vertical Sidebar -->
    <aside class="vertical-sidebar">
        <input type="checkbox" role="switch" id="checkbox-input" class="checkbox-input" checked />
        <nav>
            <header>
                <div class="sidebar__toggle-container">
                    <label tabindex="0" for="checkbox-input" id="label-for-checkbox-input" class="nav__toggle">
                        <span class="toggle--icons" aria-hidden="true">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="toggle-svg-icon toggle--open">
                                <path d="M3 5a1 1 0 1 0 0 2h18a1 1 0 1 0 0-2zM2 12a1 1 0 0 1 1-1h18a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1M2 18a1 1 0 0 1 1-1h18a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1"></path>
                            </svg>
                            <svg width="24" height="24" viewBox="0 0 24 24" class="toggle-svg-icon toggle--close">
                                <path d="M18.707 6.707a1 1 0 0 0-1.414-1.414L12 10.586 6.707 5.293a1 1 0 0 0-1.414 1.414L10.586 12l-5.293 5.293a1 1 0 1 0 1.414 1.414L12 13.414l5.293 5.293a1 1 0 0 0 1.414-1.414L13.414 12z"></path>
                            </svg>
                        </span>
                    </label>
                </div>
                <figure>
                    <img class="codepen-logo" src="https://img.icons8.com/ios-filled/50/000000/settings.png" alt="Newsly AI Settings" />
                    <figcaption>
                        <p class="user-id">Newsly AI</p>
                        <p class="user-role">ParamÃ¨tres</p>
                    </figcaption>
                </figure>
            </header>
            <section class="sidebar__wrapper">
                <ul class="sidebar__list list--primary">
                    <li class="sidebar__item item--heading">
                        <h2 class="sidebar__item--heading" data-i18n="settings.title">ParamÃ¨tres du compte</h2>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link active" href="#" data-tooltip="Profil" data-section="profile">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="settings.profile">Profil</span>
                        </a>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="#" data-tooltip="Compte" data-section="account">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="settings.account">Compte</span>
                        </a>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="#" data-tooltip="SÃ©curitÃ©" data-section="security">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="settings.security">SÃ©curitÃ©</span>
                        </a>
                    </li>
                </ul>
                <ul class="sidebar__list list--secondary" id="adminSidebarSection" style="display: none;">
                    <li class="sidebar__item item--heading">
                        <h2 class="sidebar__item--heading" data-i18n="settings.administration">Administration</h2>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="#" data-tooltip="Utilisateurs" data-section="users">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="settings.users">Utilisateurs</span>
                        </a>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="#" data-tooltip="Vercel Dashboard" data-section="vercel">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 0 0 16h16zm0 2.5L13.5 14h-11z"/>
                                </svg>
                            </span>
                            <span class="text">Vercel Dashboard</span>
                        </a>
                    </li>
                </ul>
                <ul class="sidebar__list list--secondary">
                    <li class="sidebar__item item--heading">
                        <h2 class="sidebar__item--heading">Navigation</h2>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="dashboard.html" data-tooltip="Dashboard">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v1h14V2a1 1 0 0 0-1-1zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="nav.dashboard">Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar__item">
                        <a class="sidebar__link" href="#" data-tooltip="DÃ©connexion" id="sidebarLogoutBtn">
                            <span class="icon">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                                </svg>
                            </span>
                            <span class="text" data-i18n="nav.logout">DÃ©connexion</span>
                        </a>
                    </li>
                </ul>
            </section>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="settings-layout">

        <!-- Content Area -->
        <div class="settings-content">
            <div>
            <!-- Profile Section -->
            <section id="section-profile" class="settings-section active">
                <h2 class="settings-section-title" data-i18n="settings.profile">Profil</h2>
                <p class="settings-section-desc" data-i18n="settings.manageProfile">GÃ©rez vos informations personnelles</p>

                <!-- Avatar Card -->
                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label" data-i18n="settings.avatar">Photo de profil</label>
                        <div class="avatar-upload-container">
                            <div class="avatar-preview" id="avatarPreview">
                                <img id="avatarImage" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff&size=200" alt="Avatar">
                                <div class="avatar-overlay" id="avatarOverlay">
                                    <span class="avatar-edit-icon">âœï¸</span>
                                </div>
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button type="button" id="uploadAvatarBtn" class="btn-primary" style="flex: 1;">
                                    ðŸ“· Changer
                                </button>
                                <button type="button" id="removeAvatarBtn" class="btn-danger" style="flex: 1;">
                                    ðŸ—‘ï¸ Supprimer
                                </button>
                            </div>
                            <p class="form-hint">Max 2MB - JPG, PNG ou GIF</p>
                        </div>
                    </div>
                </div>

                <!-- Profile Info Grid -->
                <div class="settings-card">
                    <div class="settings-grid-2">
                        <!-- Email (Read-only) -->
                        <div class="form-group">
                            <label for="emailDisplay" class="form-label" data-i18n="settings.email">Email</label>
                            <input
                                type="email"
                                id="emailDisplay"
                                class="form-input"
                                placeholder="exemple@email.com"
                                disabled
                                readonly
                            >
                            <p class="form-hint">L'email ne peut pas Ãªtre modifiÃ©</p>
                        </div>

                        <!-- Username (Obligatoire) -->
                        <div class="form-group">
                            <label for="usernameInput" class="form-label">
                                <span data-i18n="settings.username">Nom d'utilisateur</span>
                                <span style="color: var(--error); margin-left: 0.25rem;">*</span>
                            </label>
                            <input
                                type="text"
                                id="usernameInput"
                                class="form-input"
                                placeholder="@MonNomUtilisateur"
                                required
                            >
                            <p class="form-hint">Ex: @julien33</p>
                        </div>

                        <!-- Full Name (Obligatoire) -->
                        <div class="form-group">
                            <label for="fullNameInput" class="form-label">
                                <span data-i18n="settings.fullName">Nom complet</span>
                                <span style="color: var(--error); margin-left: 0.25rem;">*</span>
                            </label>
                            <input
                                type="text"
                                id="fullNameInput"
                                class="form-input"
                                placeholder="Julien RICHARD"
                                required
                            >
                            <p class="form-hint">Votre nom et prÃ©nom</p>
                        </div>

                        <!-- Country (Obligatoire) -->
                        <div class="form-group">
                            <label for="countrySelect" class="form-label">
                                <span data-i18n="settings.country">Pays</span>
                                <span style="color: var(--error); margin-left: 0.25rem;">*</span>
                            </label>
                            <select
                                id="countrySelect"
                                class="form-input"
                                required
                            >
                                <option value="">-- SÃ©lectionnez un pays --</option>
                            </select>
                        </div>

                    <!-- City (Obligatoire) -->
                    <div class="form-group">
                        <label for="cityInput" class="form-label">
                            <span data-i18n="settings.city">Ville</span>
                            <span style="color: var(--error); margin-left: 0.25rem;">*</span>
                        </label>
                        <input
                            type="text"
                            id="cityInput"
                            class="form-input"
                            placeholder="Bordeaux"
                            required
                        >
                    </div>

                    <!-- Phone (Optionnel) -->
                    <div class="form-group">
                        <label for="phoneInput" class="form-label" data-i18n="settings.phone">TÃ©lÃ©phone (optionnel)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="phoneCountryCode" class="form-input" style="width: 120px;">
                                <!-- Options peuplÃ©es dynamiquement depuis countries.js -->
                            </select>
                            <input
                                type="tel"
                                id="phoneInput"
                                class="form-input"
                                placeholder="6 12 34 56 78"
                                style="flex: 1;"
                            >
                        </div>
                    </div>
                    </div>

                    <button id="updateProfileBtn" class="btn-primary" data-i18n="settings.updateProfile">
                        ðŸ’¾ Enregistrer
                    </button>
                </div>
            </section>

            <!-- Account Section -->
            <section id="section-account" class="settings-section">
                <h2 class="settings-section-title">Compte</h2>
                <p class="settings-section-desc">GÃ©rez les paramÃ¨tres de votre compte</p>

                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label" data-i18n="settings.languagePreferences">PrÃ©fÃ©rences de langue</label>
                        <select id="languageSelect" class="form-input">
                            <option value="fr" data-i18n="settings.french">FranÃ§ais</option>
                            <option value="en" data-i18n="settings.english">English</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" data-i18n="settings.theme">ThÃ¨me</label>
                        <select id="themeSelect" class="form-input">
                            <option value="light" data-i18n="settings.light">Clair</option>
                            <option value="dark" data-i18n="settings.dark">Sombre</option>
                        </select>
                    </div>

                    <button id="saveAccountBtn" class="btn-primary" data-i18n="settings.savePreferences">
                        Enregistrer les prÃ©fÃ©rences
                    </button>
                </div>

                <div class="settings-card" style="margin-top: 2rem; border-color: var(--error);">
                    <h3 style="color: var(--error); margin-bottom: 0.5rem;" data-i18n="settings.dangerZone">Zone de danger</h3>
                    <p class="settings-description" data-i18n="settings.dangerZoneDesc">
                        Une fois votre compte supprimÃ©, toutes vos donnÃ©es seront dÃ©finitivement effacÃ©es. Cette action est irrÃ©versible.
                    </p>
                    <button id="deleteAccountBtn" class="btn-danger" data-i18n="settings.deleteAccount">
                        Supprimer mon compte
                    </button>
                </div>
            </section>

            <!-- Security Section -->
            <section id="section-security" class="settings-section">
                <h2 class="settings-section-title" data-i18n="settings.security">SÃ©curitÃ©</h2>
                <p class="settings-section-desc" data-i18n="settings.protectAccount">ProtÃ©gez votre compte</p>

                <div class="security-grid">
                    <div class="settings-card">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);" data-i18n="settings.changePassword">Changement de mot de passe</h3>
                        <div class="form-group">
                            <label for="currentPassword" class="form-label" data-i18n="settings.currentPassword">Mot de passe actuel</label>
                            <input
                                type="password"
                                id="currentPassword"
                                class="form-input"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                data-i18n-placeholder="settings.currentPasswordPlaceholder"
                            >
                        </div>

                        <div class="form-group">
                            <label for="newPassword" class="form-label" data-i18n="settings.newPassword">Nouveau mot de passe</label>
                            <input
                                type="password"
                                id="newPassword"
                                class="form-input"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                data-i18n-placeholder="settings.newPasswordPlaceholder"
                            >
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="form-label" data-i18n="settings.confirmPassword">Confirmer le mot de passe</label>
                            <input
                                type="password"
                                id="confirmPassword"
                                class="form-input"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                data-i18n-placeholder="settings.confirmPasswordPlaceholder"
                            >
                        </div>

                        <button id="changePasswordBtn" class="btn-primary" data-i18n="settings.changePasswordBtn">
                            Changer le mot de passe
                        </button>
                    </div>

                    <!-- Security Audit Card -->
                    <div class="settings-card">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);" data-i18n="settings.securityAudit">Audit de sÃ©curitÃ©</h3>
                        <p class="settings-description" data-i18n="settings.securityAuditDesc">
                            Consultez l'historique des activitÃ©s de sÃ©curitÃ© de votre compte
                        </p>
                        <div id="securityAuditContainer">
                            <p style="text-align: center; color: var(--text-muted);" data-i18n="settings.loadingAudit">Chargement de l'audit...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Particles Section -->
            <section id="section-particles" class="settings-section">
                <h2 class="settings-section-title" data-i18n="settings.particles">Particules d'arriÃ¨re-plan</h2>
                <p class="settings-section-desc" data-i18n="settings.customizeParticles">Personnalisez l'effet de particules animÃ©es</p>

                <div class="settings-card">
                    <div class="settings-grid-2">
                        <div class="form-group">
                            <label for="particlesNumber" class="form-label" data-i18n="settings.particlesNumber">Nombre de particules</label>
                            <input type="range" id="particlesNumber" class="form-range" min="10" max="100" value="100">
                            <span id="particlesNumberValue" class="form-hint">100</span>
                        </div>

                        <div class="form-group">
                            <label for="particlesColor" class="form-label" data-i18n="settings.particlesColor">Couleur des particules</label>
                            <input type="color" id="particlesColor" class="form-input" value="#fffe7a">
                        </div>

                        <div class="form-group">
                            <label for="particlesSpeed" class="form-label" data-i18n="settings.particlesSpeed">Vitesse de dÃ©placement</label>
                            <input type="range" id="particlesSpeed" class="form-range" min="0" max="10" step="0.1" value="0.5">
                            <span id="particlesSpeedValue" class="form-hint">0.5</span>
                        </div>

                        <div class="form-group">
                            <label for="particlesOpacity" class="form-label" data-i18n="settings.particlesOpacity">OpacitÃ©</label>
                            <input type="range" id="particlesOpacity" class="form-range" min="0" max="1" step="0.01" value="0.28">
                            <span id="particlesOpacityValue" class="form-hint">0.28</span>
                        </div>

                        <div class="form-group">
                            <label for="lineDistance" class="form-label" data-i18n="settings.lineDistance">Distance des lignes</label>
                            <input type="range" id="lineDistance" class="form-range" min="0" max="150" value="60">
                            <span id="lineDistanceValue" class="form-hint">60</span>
                        </div>

                        <div class="form-group">
                            <label for="lineColor" class="form-label" data-i18n="settings.lineColor">Couleur des lignes</label>
                            <input type="color" id="lineColor" class="form-input" value="#7c9149">
                        </div>

                        <div class="form-group">
                            <label for="lineOpacity" class="form-label" data-i18n="settings.lineOpacity">OpacitÃ© des lignes</label>
                            <input type="range" id="lineOpacity" class="form-range" min="0" max="1" step="0.01" value="0.39">
                            <span id="lineOpacityValue" class="form-hint">0.39</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label" data-i18n="settings.hoverInteraction">Interaction au survol</label>
                            <div class="toggle-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="hoverEnabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="hoverEnabledText" class="form-hint" data-i18n="settings.enabled">ActivÃ©</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="repulseDistance" class="form-label" data-i18n="settings.repulseDistance">Distance de rÃ©pulsion</label>
                            <input type="range" id="repulseDistance" class="form-range" min="50" max="300" value="100">
                            <span id="repulseDistanceValue" class="form-hint">100</span>
                        </div>

                        <div class="form-group">
                            <label for="particlesBlur" class="form-label" data-i18n="settings.particlesBlur">Flou des particules</label>
                            <input type="range" id="particlesBlur" class="form-range" min="0" max="20" step="0.5" value="0">
                            <span id="particlesBlurValue" class="form-hint">0 px</span>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="saveParticlesBtn" class="btn-primary" data-i18n="settings.saveSettings">
                            ðŸ’¾ Enregistrer
                        </button>
                        <button id="resetParticlesBtn" class="btn-primary" data-i18n="settings.default">
                            ðŸ”„ DÃ©faut
                        </button>
                    </div>
                </div>
            </section>

            <!-- Users Management Section (Admin only) -->
            <section id="section-users" class="settings-section">
                <h2 class="settings-section-title" data-i18n="settings.users">Gestion des utilisateurs</h2>
                <p class="settings-section-desc" data-i18n="settings.manageUsers">GÃ©rez les utilisateurs et leurs comptes</p>

                <!-- Stats Cards -->
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalUsers">-</div>
                            <div class="stat-label">Utilisateurs</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘‘</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalAdmins">-</div>
                            <div class="stat-label">Administrateurs</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“…</div>
                        <div class="stat-info">
                            <div class="stat-value" id="recentUsers">-</div>
                            <div class="stat-label">Cette semaine</div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="settings-card" style="margin-top: 1.5rem;">
                    <div id="usersTableContainer">
                        <p style="text-align: center; color: var(--text-muted);" data-i18n="settings.loadingUsers">Chargement des utilisateurs...</p>
                    </div>
                </div>
            </section>

            <!-- Vercel Dashboard Section (Admin only) -->
            <section id="section-vercel" class="settings-section">
                <h2 class="settings-section-title">Vercel Dashboard</h2>
                <p class="settings-section-desc">Suivez vos dÃ©ploiements Vercel en temps rÃ©el</p>

                <!-- Stats Cards -->
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸš€</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalDeployments">-</div>
                            <div class="stat-label">DÃ©ploiements</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-info">
                            <div class="stat-value" id="readyDeployments">-</div>
                            <div class="stat-label">PrÃªts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âŒ</div>
                        <div class="stat-info">
                            <div class="stat-value" id="errorDeployments">-</div>
                            <div class="stat-label">Erreurs</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âš¡</div>
                        <div class="stat-info">
                            <div class="stat-value" id="avgBuildTime">-</div>
                            <div class="stat-label">Build moyen (s)</div>
                        </div>
                    </div>
                </div>

                <!-- Deployments Table -->
                <div class="settings-card" style="margin-top: 1.5rem;">
                    <div id="deploymentsTableContainer">
                        <p style="text-align: center; color: var(--text-muted);">Chargement des dÃ©ploiements...</p>
                    </div>
                </div>
            </section>

            </div>
        </div>
    </div>

    <!-- Particles.js Library -->
    <!-- DÃ‰SACTIVÃ‰ - Conflit avec Aurora et Dark/Light Mode
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    -->

    <script type="module">
        import { checkAuth, getUserProfile, updateUserProfile, changePassword, deleteAccount, logout } from './public/js/app.js';
        import { escapeHtml, showSuccess, showError } from './public/js/dashboard-utils.js';
        import { translatePage } from './public/js/translation-service.js';
        // DÃ‰SACTIVÃ‰ - Conflit avec Aurora et Dark/Light Mode
        // import { initParticles } from './public/js/particles-config.js';
        import { countries } from './public/js/countries.js';
        import { attachPhoneFormatter } from './public/js/phone-formatter.js';

        // Initialize particles (async to load from DB)
        // DÃ‰SACTIVÃ‰ - Conflit avec Aurora et Dark/Light Mode
        /*
        (async () => {
            await initParticles('particles-js');
        })();
        */

        // VÃ©rifier l'authentification
        const isAuth = checkAuth();
        if (!isAuth) {
            window.location.href = 'index.html';
        }

        // Variable globale pour stocker l'avatar
        let currentAvatarUrl = null;

        // Populer le select des pays
        const countrySelect = document.getElementById('countrySelect');
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            option.textContent = `${country.emoji} ${country.name}`;
            countrySelect.appendChild(option);
        });

        // Populer le select des codes tÃ©lÃ©phoniques depuis countries.js
        const phoneCountryCodeSelect = document.getElementById('phoneCountryCode');
        const phoneInput = document.getElementById('phoneInput');
        if (phoneCountryCodeSelect) {
            // Vider les options existantes
            phoneCountryCodeSelect.innerHTML = '';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.dial_code;
                option.textContent = `${country.emoji} ${country.dial_code}`;
                phoneCountryCodeSelect.appendChild(option);
            });
            // SÃ©lectionner +33 (France) par dÃ©faut
            phoneCountryCodeSelect.value = '+33';

            // Attach phone number formatter
            if (phoneInput) {
                attachPhoneFormatter(phoneInput, phoneCountryCodeSelect);
            }
        }

        // Charger le profil utilisateur
        const loadProfile = async () => {
            const result = await getUserProfile();
            if (result.success) {
                const profile = result.profile;
                console.log('ðŸ“‹ Profil chargÃ© depuis la base:', profile);
                const userName = profile.username || profile.email.split('@')[0];
                const userRole = profile.role || 'user';

                // Navbar role badge
                const navUserRole = document.getElementById('navUserRole');

                if (navUserRole) {
                    if (userRole === 'admin') {
                        navUserRole.textContent = 'ConnectÃ© en tant qu\'admin';
                        navUserRole.className = 'user-role-badge admin';
                    } else {
                        navUserRole.textContent = `ConnectÃ© en tant que ${escapeHtml(userName)}`;
                        navUserRole.className = 'user-role-badge user';
                    }
                }

                // Email (toujours prÃ©sent)
                document.getElementById('emailDisplay').value = profile.email;

                // Avatar
                if (profile.avatar_url) {
                    currentAvatarUrl = profile.avatar_url;
                    document.getElementById('avatarImage').src = profile.avatar_url;
                } else {
                    // Avatar par dÃ©faut avec initiales
                    const name = profile.username || profile.email.split('@')[0];
                    document.getElementById('avatarImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3ecf8e&color=fff&size=200`;
                }

                // Champs obligatoires
                document.getElementById('usernameInput').value = profile.username || '';
                document.getElementById('fullNameInput').value = profile.full_name || '';

                // Country - s'assurer que la valeur existe dans le select
                const countryValue = profile.country || 'France';
                console.log('ðŸŒ Pays depuis la base:', countryValue);
                const countryOptions = Array.from(countrySelect.options);
                const countryExists = countryOptions.some(opt => opt.value === countryValue);
                console.log('âœ… Pays existe dans le select?', countryExists);

                if (countryExists) {
                    countrySelect.value = countryValue;
                    console.log('âœ… Pays sÃ©lectionnÃ©:', countrySelect.value);
                } else {
                    console.warn(`âš ï¸ Pays "${countryValue}" non trouvÃ© dans la liste, utilisation de France par dÃ©faut`);
                    countrySelect.value = 'France';
                }

                const cityValue = profile.city || '';
                console.log('ðŸ™ï¸ Ville depuis la base:', cityValue);
                document.getElementById('cityInput').value = cityValue;

                // Champs optionnels - TÃ©lÃ©phone
                if (profile.phone && profile.phone.trim() !== '') {
                    console.log('ðŸ“ž TÃ©lÃ©phone depuis la base:', profile.phone);
                    // SÃ©parer l'indicatif du numÃ©ro
                    const phoneMatch = profile.phone.match(/^(\+\d+)\s*(.+)$/);
                    if (phoneMatch) {
                        const indicatif = phoneMatch[1];
                        const numero = phoneMatch[2];
                        console.log('ðŸ“ž Indicatif:', indicatif, 'NumÃ©ro:', numero);

                        // VÃ©rifier si l'indicatif existe dans le select
                        const phoneCodeSelect = document.getElementById('phoneCountryCode');
                        const codeExists = Array.from(phoneCodeSelect.options).some(opt => opt.value === indicatif);

                        if (codeExists) {
                            phoneCodeSelect.value = indicatif;
                            console.log('âœ… Indicatif sÃ©lectionnÃ©:', phoneCodeSelect.value);
                        } else {
                            console.warn(`âš ï¸ Indicatif "${indicatif}" non trouvÃ©, utilisation de +33 par dÃ©faut`);
                            phoneCodeSelect.value = '+33';
                        }

                        document.getElementById('phoneInput').value = numero;
                        console.log('âœ… NumÃ©ro chargÃ©:', numero);
                    } else {
                        // Format de tÃ©lÃ©phone invalide, mettre le numÃ©ro complet dans le champ
                        console.warn('âš ï¸ Format tÃ©lÃ©phone invalide, mise du numÃ©ro complet');
                        document.getElementById('phoneInput').value = profile.phone;
                    }
                }

                if (profile.bio) {
                    const bioInput = document.getElementById('bioInput');
                    if (bioInput) {
                        bioInput.value = profile.bio;
                        const bioCount = document.getElementById('bioCount');
                        if (bioCount) {
                            bioCount.textContent = profile.bio.length;
                        }
                    }
                }

                // Valider le formulaire aprÃ¨s chargement
                validateForm();
            }
        };

        // Gestion de l'upload d'avatar
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarInput = document.getElementById('avatarInput');
        const avatarImage = document.getElementById('avatarImage');
        const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
        const removeAvatarBtn = document.getElementById('removeAvatarBtn');

        // Compteur de caractÃ¨res pour la bio (si prÃ©sent)
        const bioInput = document.getElementById('bioInput');
        const bioCount = document.getElementById('bioCount');
        if (bioInput && bioCount) {
            bioInput.addEventListener('input', () => {
                bioCount.textContent = bioInput.value.length;
            });
        }

        // Validation en temps rÃ©el et activation/dÃ©sactivation du bouton
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const validateForm = () => {
            const username = document.getElementById('usernameInput').value.trim();
            const fullName = document.getElementById('fullNameInput').value.trim();
            const country = document.getElementById('countrySelect').value;
            const city = document.getElementById('cityInput').value.trim();

            const isValid = username && fullName && country && city;

            if (isValid) {
                updateProfileBtn.disabled = false;
                updateProfileBtn.style.opacity = '1';
                updateProfileBtn.style.cursor = 'pointer';
            } else {
                updateProfileBtn.disabled = true;
                updateProfileBtn.style.opacity = '0.5';
                updateProfileBtn.style.cursor = 'not-allowed';
            }
        };

        // Ã‰couter les changements sur les champs obligatoires
        document.getElementById('usernameInput').addEventListener('input', validateForm);
        document.getElementById('fullNameInput').addEventListener('input', validateForm);
        document.getElementById('countrySelect').addEventListener('change', validateForm);
        document.getElementById('cityInput').addEventListener('input', validateForm);

        // Bouton "Changer la photo"
        uploadAvatarBtn.addEventListener('click', () => {
            avatarInput.click();
        });

        // Cliquer sur l'avatar ouvre aussi le sÃ©lecteur
        avatarPreview.addEventListener('click', () => {
            avatarInput.click();
        });

        // Bouton "Supprimer la photo"
        removeAvatarBtn.addEventListener('click', () => {
            currentAvatarUrl = null;
            const userName = document.getElementById('usernameInput').value || 'User';
            avatarImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=3b82f6&color=fff&size=200`;
            showSuccess('Photo supprimÃ©e (cliquez sur "Mettre Ã  jour" pour sauvegarder)');
        });

        // Fonction pour compresser l'image
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Redimensionner Ã  max 200x200 pour limiter la taille
                        const MAX_SIZE = 200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height = Math.round((height * MAX_SIZE) / width);
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width = Math.round((width * MAX_SIZE) / height);
                                height = MAX_SIZE;
                            }
                        }

                        // CrÃ©er un canvas pour redimensionner
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convertir en base64 avec compression JPEG (qualitÃ© 0.8)
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // GÃ©rer la sÃ©lection d'image
        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validation: type d'image
            if (!file.type.startsWith('image/')) {
                showError('Veuillez sÃ©lectionner une image valide');
                return;
            }

            // Validation: taille max 2MB
            const maxSize = 2 * 1024 * 1024; // 2MB en bytes
            if (file.size > maxSize) {
                showError('L\'image ne doit pas dÃ©passer 2 MB');
                return;
            }

            try {
                // Compresser l'image
                const compressedBase64 = await compressImage(file);

                // PrÃ©visualisation locale
                avatarImage.src = compressedBase64;
                currentAvatarUrl = compressedBase64;

                const sizeKB = Math.round((compressedBase64.length * 0.75) / 1024);
                showSuccess(`Image compressÃ©e (${sizeKB} KB) ! Cliquez sur "Mettre Ã  jour le profil" pour sauvegarder`);
            } catch (error) {
                showError('Erreur lors de la compression de l\'image');
                console.error(error);
            }
        });

        // Mettre Ã  jour le profil
        updateProfileBtn.addEventListener('click', async () => {
            const username = document.getElementById('usernameInput').value.trim();
            const fullName = document.getElementById('fullNameInput').value.trim();
            const country = document.getElementById('countrySelect').value;
            const city = document.getElementById('cityInput').value.trim();
            const phoneNumber = document.getElementById('phoneInput').value.trim();
            const phoneCode = document.getElementById('phoneCountryCode').value;
            const phone = phoneNumber ? `${phoneCode} ${phoneNumber}` : '';
            const bioInput = document.getElementById('bioInput');
            const bio = bioInput ? bioInput.value.trim() : '';

            // Validations (dÃ©jÃ  faites par le bouton, mais double-check)
            if (!username || !fullName || !country || !city) {
                showError('Veuillez remplir tous les champs obligatoires (Username, Nom complet, Pays, Ville)');
                return;
            }

            // Construire l'objet avec seulement les champs nÃ©cessaires
            const profileData = {
                username,
                full_name: fullName,
                country,
                city
            };

            // Ajouter les champs optionnels seulement s'ils sont remplis
            if (phone) {
                profileData.phone = phone;
            }
            if (bio) {
                profileData.bio = bio;
            }
            // Avatar peut Ãªtre null (pour supprimer) ou une URL/base64
            profileData.avatar_url = currentAvatarUrl;

            const result = await updateUserProfile(profileData);

            if (result.success) {
                showSuccess('Profil mis Ã  jour avec succÃ¨s !');
                // Mettre Ã  jour l'avatar dans le burger menu
                if (currentAvatarUrl) {
                    document.getElementById('burgerAvatarImage').src = currentAvatarUrl;
                }
            } else {
                showError(result.error || 'Erreur lors de la mise Ã  jour');
            }
        });

        // Changer le mot de passe
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation du mot de passe actuel
            if (!currentPassword || currentPassword.trim() === '') {
                showError('Veuillez saisir votre mot de passe actuel');
                return;
            }

            if (!newPassword || !confirmPassword) {
                showError('Veuillez remplir le nouveau mot de passe et sa confirmation');
                return;
            }

            if (newPassword.length < 8) {
                showError('Le mot de passe doit contenir au moins 8 caractÃ¨res');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Les mots de passe ne correspondent pas');
                return;
            }

            const result = await changePassword(newPassword);

            if (result.success) {
                showSuccess('Mot de passe changÃ© avec succÃ¨s !');
                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showError(result.error || 'Erreur lors du changement de mot de passe');
            }
        });

        // Supprimer le compte
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer votre compte ? Cette action est irrÃ©versible !')) {
                if (confirm('ðŸš¨ DERNIÃˆRE CONFIRMATION : Toutes vos donnÃ©es seront perdues. Continuer ?')) {
                    const result = await deleteAccount();
                    if (result.success) {
                        alert('âœ… Compte supprimÃ© avec succÃ¨s');
                        window.location.href = 'index.html';
                    } else {
                        showError(result.error || 'Erreur lors de la suppression');
                    }
                }
            }
        });

        // GÃ©rer le burger menu
        const burgerBtn = document.getElementById('burgerBtn');
        const burgerMenu = document.getElementById('burgerMenu');

        // Initialiser AVANT d'attacher les event listeners
        let burgerInitialized = true;

        burgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            burgerBtn.classList.toggle('active');
            burgerMenu.classList.toggle('show');
        });

        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', () => {
            burgerBtn.classList.remove('active');
            burgerMenu.classList.remove('show');
        });

        // EmpÃªcher la fermeture si on clique dans le menu
        burgerMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ================================================
        // WEATHER WIDGET
        // ================================================

        const weatherWidget = document.getElementById('weatherWidget');

        const getWeatherIcon = (weatherCode) => {
            // WMO Weather codes: https://open-meteo.com/en/docs
            if (weatherCode === 0) return 'â˜€ï¸'; // Clear sky
            if (weatherCode <= 3) return 'â›…'; // Partly cloudy
            if (weatherCode <= 48) return 'ðŸŒ«ï¸'; // Fog
            if (weatherCode <= 67) return 'ðŸŒ§ï¸'; // Rain
            if (weatherCode <= 77) return 'ðŸŒ¨ï¸'; // Snow
            if (weatherCode <= 82) return 'ðŸŒ§ï¸'; // Showers
            if (weatherCode <= 99) return 'â›ˆï¸'; // Thunderstorm
            return 'â˜ï¸';
        };

        const fetchWeather = async (lat, lon) => {
            try {
                // AbortController pour timeout de 5 secondes
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`,
                    { signal: controller.signal }
                );
                clearTimeout(timeoutId);

                const data = await response.json();

                const temp = Math.round(data.current.temperature_2m);
                const weatherCode = data.current.weather_code;
                const icon = getWeatherIcon(weatherCode);

                // Get city name from reverse geocoding using Nominatim (OpenStreetMap)
                const geoController = new AbortController();
                const geoTimeoutId = setTimeout(() => geoController.abort(), 5000);

                const geoResponse = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=fr`,
                    { signal: geoController.signal }
                );
                clearTimeout(geoTimeoutId);

                const geoData = await geoResponse.json();
                const city = geoData.address?.city || geoData.address?.town || geoData.address?.village || geoData.address?.state || 'Votre position';

                weatherWidget.innerHTML = `
                    <div class="weather-info">
                        <span class="weather-icon">${icon}</span>
                        <div class="weather-details">
                            <span class="weather-temp">${temp}Â°C</span>
                            <span class="weather-city">${city}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erreur mÃ©tÃ©o:', error);
                weatherWidget.innerHTML = `
                    <div class="weather-error">
                        <span>ðŸŒ¡ï¸</span>
                    </div>
                `;
            }
        };

        const loadWeather = () => {
            // Check if geolocation is available in localStorage
            const savedLat = localStorage.getItem('weatherLat');
            const savedLon = localStorage.getItem('weatherLon');

            if (savedLat && savedLon) {
                fetchWeather(parseFloat(savedLat), parseFloat(savedLon));
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        localStorage.setItem('weatherLat', lat);
                        localStorage.setItem('weatherLon', lon);
                        fetchWeather(lat, lon);
                    },
                    (error) => {
                        console.log('GÃ©olocalisation refusÃ©e, utilisation de Paris par dÃ©faut');
                        // Afficher un message Ã  l'utilisateur
                        weatherWidget.innerHTML = `
                            <div class="weather-info" style="opacity: 0.7;">
                                <span class="weather-icon">ðŸ“</span>
                                <div class="weather-details">
                                    <div class="weather-temp" style="font-size: 0.875rem;">Position par dÃ©faut</div>
                                    <div class="weather-location" style="font-size: 0.75rem;">GÃ©olocalisation dÃ©sactivÃ©e</div>
                                </div>
                            </div>
                        `;
                        // Puis charger mÃ©tÃ©o Paris aprÃ¨s 2s
                        setTimeout(() => {
                            fetchWeather(48.8566, 2.3522); // Paris par dÃ©faut
                        }, 2000);
                    }
                );
            } else {
                // Paris par dÃ©faut si pas de gÃ©olocalisation
                fetchWeather(48.8566, 2.3522);
            }
        };

        // Load weather on page load
        loadWeather();

        // Refresh weather every 10 minutes
        setInterval(loadWeather, 10 * 60 * 1000);

        // ================================================
        // ACCOUNT SETTINGS
        // ================================================

        // Load current preferences in Account section
        const languageSelect = document.getElementById('languageSelect');
        const themeSelect = document.getElementById('themeSelect');

        const savedThemeForSelect = localStorage.getItem('theme') || 'light';
        const savedLangForSelect = localStorage.getItem('language') || 'fr';

        themeSelect.value = savedThemeForSelect;
        languageSelect.value = savedLangForSelect;

        // Save account preferences button
        document.getElementById('saveAccountBtn').addEventListener('click', async () => {
            const newTheme = themeSelect.value;
            const newLang = languageSelect.value;

            // Apply theme
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Apply language
            localStorage.setItem('language', newLang);

            // Update burger menu toggles
            themeToggle.checked = newTheme === 'dark';
            themeText.textContent = newTheme === 'dark' ? 'Mode sombre' : 'Mode clair';
            langToggle.checked = newLang === 'en';

            // Traduire d'abord
            await translatePage();

            showSuccess('PrÃ©fÃ©rences enregistrÃ©es avec succÃ¨s !');
        });

        // GÃ©rer le toggle du thÃ¨me
        const themeToggle = document.getElementById('themeToggle');
        const themeText = document.getElementById('themeText');

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.checked = savedTheme === 'dark';
        themeText.textContent = savedTheme === 'dark' ? 'Mode sombre' : 'Mode clair';

        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeText.textContent = newTheme === 'dark' ? 'Mode sombre' : 'Mode clair';
        });

        // GÃ©rer le switch de langue
        const langToggle = document.getElementById('langToggle');
        const savedLang = localStorage.getItem('language') || 'fr';
        langToggle.checked = savedLang === 'en';

        langToggle.addEventListener('change', () => {
            const newLang = langToggle.checked ? 'en' : 'fr';
            localStorage.setItem('language', newLang);

            // Mettre Ã  jour le label du switch dans le burger menu
            const langLabel = document.getElementById('langLabel');
            if (langLabel) {
                langLabel.textContent = newLang === 'en' ? 'English / FranÃ§ais' : 'FranÃ§ais / English';
            }

            translatePage();
        });

        // Bouton Dashboard
        document.getElementById('dashboardBtn').addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        // Bouton Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            logout();
        });

        // ================================================
        // MENU MOBILE - Gestion settings nav responsive
        // ================================================
        const mobileSettingsNavBtn = document.getElementById('mobileSettingsNavBtn');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const settingsNav = document.querySelector('.dashboard-sidebar');

        // Fonction pour fermer le menu settings mobile
        const closeSettingsMobileMenu = () => {
            settingsNav.classList.remove('mobile-open');
            mobileOverlay.classList.remove('show');
            document.body.style.overflow = ''; // RÃ©activer scroll
        };

        // Fonction pour ouvrir le menu settings mobile
        const openSettingsMobileMenu = () => {
            settingsNav.classList.add('mobile-open');
            mobileOverlay.classList.add('show');
            document.body.style.overflow = 'hidden'; // EmpÃªcher scroll background
        };

        // Toggle menu avec le bouton burger
        if (mobileSettingsNavBtn) {
            mobileSettingsNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (settingsNav.classList.contains('mobile-open')) {
                    closeSettingsMobileMenu();
                } else {
                    openSettingsMobileMenu();
                }
            });

            // Support touch events pour iOS
            mobileSettingsNavBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                mobileSettingsNavBtn.click();
            }, { passive: false });
        }

        // Fermer avec overlay (click et touch)
        if (mobileOverlay) {
            mobileOverlay.addEventListener('click', closeSettingsMobileMenu);
            mobileOverlay.addEventListener('touchend', (e) => {
                e.preventDefault();
                closeSettingsMobileMenu();
            }, { passive: false });
        }

        // Fermer nav aprÃ¨s sÃ©lection section sur mobile
        document.querySelectorAll('.settings-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    setTimeout(closeSettingsMobileMenu, 100); // Petit dÃ©lai pour UX
                }
            });
        });

        // Fermer avec touche Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsNav.classList.contains('mobile-open')) {
                closeSettingsMobileMenu();
            }
        });

        // Charger le nom utilisateur pour le burger
        const loadUserName = async () => {
            const result = await getUserProfile();
            if (result.success) {
                const userName = result.profile.username || result.profile.email.split('@')[0];
                document.getElementById('userNameDisplay').textContent = `User: ${escapeHtml(userName)}`;

                // Charger l'avatar dans le burger
                if (result.profile.avatar_url) {
                    document.getElementById('burgerAvatarImage').src = result.profile.avatar_url;
                } else {
                    document.getElementById('burgerAvatarImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=3ecf8e&color=fff&size=72`;
                }
            }
        };

        // ================================================
        // SETTINGS NAVIGATION
        // ================================================

        // Get all navigation items and sections
        const navItems = document.querySelectorAll('.settings-nav-item');
        const sections = document.querySelectorAll('.settings-section');
        const usersNavBtn = document.getElementById('usersNavBtn');
        const usersSection = document.getElementById('section-users');

        // Handle section switching
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = item.dataset.section;

                // Remove active class from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));

                // Add active class to clicked item
                item.classList.add('active');

                // Hide all sections
                sections.forEach(section => section.classList.remove('active'));

                // Show selected section
                const targetSection = document.getElementById(`section-${sectionId}`);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
            });
        });

        // Show/hide Admin section - only for specific admin email with is_admin true in DB
        const checkAdminAccess = async () => {
            const result = await getUserProfile();
            // VÃ©rifier is_admin directement depuis le profil (colonne profiles.is_admin)
            if (result.success && result.profile.is_admin === true) {
                // Show admin section
                document.getElementById('adminSectionHeader').style.display = 'flex';
                document.getElementById('adminSectionContent').style.display = 'block';

                // Load users list and Vercel deployments for admin
                loadUsersList();
                loadVercelDeployments();
            }
        };

        // Load users list (admin only)
        const loadUsersList = async () => {
            const usersContainer = document.getElementById('usersTableContainer');

            try {
                // Appel API sÃ©curisÃ© backend
                const API_BASE_URL = window.location.hostname === 'localhost'
                    ? 'http://localhost:3000'
                    : 'https://prod-julien.vercel.app';

                // RÃ©cupÃ©rer le token depuis la session
                const session = localStorage.getItem('session');
                if (!session) {
                    throw new Error('Session non trouvÃ©e');
                }
                const { access_token } = JSON.parse(session);

                const response = await fetch(`${API_BASE_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${access_token}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors du chargement des utilisateurs');
                }

                const { users, stats } = await response.json();

                // Update stat cards
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalAdmins').textContent = stats.totalAdmins;
                document.getElementById('recentUsers').textContent = stats.recentUsers;

                if (!users || users.length === 0) {
                    usersContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucun utilisateur trouvÃ©</p>';
                    return;
                }

                // Create users table
                let tableHTML = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Nom d'utilisateur</th>
                                <th>Nom complet</th>
                                <th>RÃ´le</th>
                                <th>CrÃ©Ã© le</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                const currentUser = await getUserProfile();
                const currentUserId = currentUser.profile?.id;

                users.forEach(user => {
                    const isCurrentUser = user.id === currentUserId;
                    const displayName = user.username || '-';
                    const fullName = user.full_name || '-';
                    const createdAt = new Date(user.created_at).toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });

                    tableHTML += `
                        <tr>
                            <td>${escapeHtml(user.email)}</td>
                            <td><strong>${escapeHtml(displayName)}</strong></td>
                            <td>${escapeHtml(fullName)}</td>
                            <td>
                                <span class="role-badge ${user.role}">${user.role}</span>
                            </td>
                            <td>${createdAt}</td>
                            <td>
                                ${!isCurrentUser ? `
                                    <button class="btn-delete-user" data-user-id="${user.id}" data-user-email="${escapeHtml(user.email)}">
                                        ðŸ—‘ï¸ Supprimer
                                    </button>
                                ` : '<span style="color: var(--text-muted); font-size: 0.875rem;">Vous</span>'}
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                usersContainer.innerHTML = tableHTML;

                // Add event listeners for delete buttons
                document.querySelectorAll('.btn-delete-user').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const userId = btn.dataset.userId;
                        const userEmail = btn.dataset.userEmail;

                        if (confirm(`âš ï¸ ATTENTION: Voulez-vous vraiment supprimer le compte de ${userEmail} ?\n\nCette action est IRRÃ‰VERSIBLE et supprimera:\n- Le compte utilisateur\n- Toutes les donnÃ©es associÃ©es\n- L'accÃ¨s Ã  l'application\n\nConfirmer la suppression ?`)) {
                            try {
                                btn.disabled = true;
                                btn.textContent = 'Suppression...';

                                const API_BASE_URL = window.location.hostname === 'localhost'
                                    ? 'http://localhost:3000'
                                    : 'https://prod-julien.vercel.app';

                                // RÃ©cupÃ©rer le token depuis la session
                                const session = localStorage.getItem('session');
                                if (!session) {
                                    throw new Error('Session non trouvÃ©e');
                                }
                                const { access_token } = JSON.parse(session);

                                const deleteResponse = await fetch(`${API_BASE_URL}/api/admin/users`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${access_token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ userId })
                                });

                                if (!deleteResponse.ok) {
                                    const error = await deleteResponse.json();
                                    throw new Error(error.error || 'Erreur lors de la suppression');
                                }

                                showSuccess('âœ… Utilisateur supprimÃ© avec succÃ¨s');
                                loadUsersList(); // Reload the list
                            } catch (error) {
                                showError('âŒ Erreur: ' + error.message);
                                console.error(error);
                                btn.disabled = false;
                                btn.textContent = 'ðŸ—‘ï¸ Supprimer';
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                usersContainer.innerHTML = '<p style="text-align: center; color: var(--error);">Erreur lors du chargement des utilisateurs</p>';
            }
        };

        // Load Vercel deployments (admin only)
        const loadVercelDeployments = async () => {
            const deploymentsContainer = document.getElementById('deploymentsTableContainer');

            try {
                // Appel API sÃ©curisÃ© backend
                const API_BASE_URL = window.location.hostname === 'localhost'
                    ? 'http://localhost:3000'
                    : 'https://prod-julien.vercel.app';

                // RÃ©cupÃ©rer le token depuis la session
                const session = localStorage.getItem('session');
                if (!session) {
                    throw new Error('Session non trouvÃ©e');
                }
                const { access_token } = JSON.parse(session);

                const response = await fetch(`${API_BASE_URL}/api/admin/vercel`, {
                    headers: { 'Authorization': `Bearer ${access_token}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors du chargement des dÃ©ploiements');
                }

                const { deployments, stats } = await response.json();

                // Update stat cards
                document.getElementById('totalDeployments').textContent = stats.total;
                document.getElementById('readyDeployments').textContent = stats.ready;
                document.getElementById('errorDeployments').textContent = stats.error;
                document.getElementById('avgBuildTime').textContent = stats.avgBuildTime;

                if (!deployments || deployments.length === 0) {
                    deploymentsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucun dÃ©ploiement trouvÃ©</p>';
                    return;
                }

                // Create deployments table
                let tableHTML = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>URL</th>
                                <th>Ã‰tat</th>
                                <th>Type</th>
                                <th>CrÃ©Ã© le</th>
                                <th>CrÃ©ateur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                deployments.forEach(deployment => {
                    const createdAt = new Date(deployment.created).toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Ã‰tat badge avec couleurs
                    let stateBadge = '';
                    if (deployment.state === 'READY') {
                        stateBadge = '<span class="role-badge" style="background: var(--success); color: white;">âœ… READY</span>';
                    } else if (deployment.state === 'ERROR') {
                        stateBadge = '<span class="role-badge" style="background: var(--error); color: white;">âŒ ERROR</span>';
                    } else if (deployment.state === 'BUILDING') {
                        stateBadge = '<span class="role-badge" style="background: var(--warning); color: white;">âš™ï¸ BUILDING</span>';
                    } else {
                        stateBadge = `<span class="role-badge" style="background: var(--text-muted); color: white;">${deployment.state}</span>`;
                    }

                    // Type badge
                    let typeBadge = '';
                    if (deployment.target === 'production') {
                        typeBadge = '<span class="role-badge admin">ðŸš€ Production</span>';
                    } else {
                        typeBadge = '<span class="role-badge user">ðŸ”„ Preview</span>';
                    }

                    tableHTML += `
                        <tr>
                            <td><strong>${escapeHtml(deployment.name)}</strong></td>
                            <td><a href="https://${escapeHtml(deployment.url)}" target="_blank" rel="noopener" style="color: var(--primary); text-decoration: none;">${escapeHtml(deployment.url)}</a></td>
                            <td>${stateBadge}</td>
                            <td>${typeBadge}</td>
                            <td>${createdAt}</td>
                            <td>${escapeHtml(deployment.creator)}</td>
                            <td>
                                <a href="${deployment.inspectorUrl}" target="_blank" rel="noopener" class="btn-delete-user" style="background: var(--primary); text-decoration: none; display: inline-block;">
                                    ðŸ” Inspecter
                                </a>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                deploymentsContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error('Erreur lors du chargement des dÃ©ploiements:', error);
                deploymentsContainer.innerHTML = `<p style="text-align: center; color: var(--error);">Erreur: ${error.message}</p>`;
            }
        };

        // ================================================
        // SECURITY AUDIT
        // ================================================

        const loadSecurityAudit = async () => {
            const auditContainer = document.getElementById('securityAuditContainer');

            // RÃ©cupÃ©rer l'IP publique
            let publicIP = 'Non disponible';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                publicIP = ipData.ip;
            } catch (error) {
                console.warn('Impossible de rÃ©cupÃ©rer l\'IP publique:', error);
            }

            // Get audit events from localStorage (mock data for now)
            const auditEvents = [
                {
                    type: 'success',
                    icon: 'âœ…',
                    title: 'Connexion rÃ©ussie',
                    description: 'Vous vous Ãªtes connectÃ© Ã  votre compte',
                    timestamp: new Date(),
                    ip: publicIP,
                    device: 'Chrome sur Windows'
                },
                {
                    type: 'info',
                    icon: 'ðŸ”',
                    title: 'Changement de mot de passe',
                    description: 'Votre mot de passe a Ã©tÃ© modifiÃ© avec succÃ¨s',
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                    ip: publicIP,
                    device: 'Chrome sur Windows'
                },
                {
                    type: 'info',
                    icon: 'ðŸ‘¤',
                    title: 'Mise Ã  jour du profil',
                    description: 'Vos informations de profil ont Ã©tÃ© modifiÃ©es',
                    timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                    ip: publicIP,
                    device: 'Chrome sur Windows'
                },
                {
                    type: 'success',
                    icon: 'âœ…',
                    title: 'Connexion rÃ©ussie',
                    description: 'Vous vous Ãªtes connectÃ© Ã  votre compte',
                    timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
                    ip: publicIP,
                    device: 'Safari sur macOS'
                },
                {
                    type: 'warning',
                    icon: 'âš ï¸',
                    title: 'Tentative de connexion Ã©chouÃ©e',
                    description: 'Mot de passe incorrect',
                    timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
                    ip: '203.45.67.89',
                    device: 'Firefox sur Linux'
                }
            ];

            if (auditEvents.length === 0) {
                auditContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucune activitÃ© rÃ©cente</p>';
                return;
            }

            let auditHTML = '<div class="audit-list">';

            auditEvents.forEach(event => {
                const formattedDate = event.timestamp.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                auditHTML += `
                    <div class="audit-item">
                        <div class="audit-icon ${event.type}">
                            ${event.icon}
                        </div>
                        <div class="audit-content">
                            <div class="audit-title">${escapeHtml(event.title)}</div>
                            <div class="audit-description">${escapeHtml(event.description)}</div>
                            <div class="audit-meta">
                                <span>ðŸ“… ${formattedDate}</span>
                                <span>ðŸ“ ${escapeHtml(event.ip)}</span>
                                <span>ðŸ’» ${escapeHtml(event.device)}</span>
                            </div>
                        </div>
                        <span class="audit-badge ${event.type}">${event.type}</span>
                    </div>
                `;
            });

            auditHTML += '</div>';
            auditContainer.innerHTML = auditHTML;
        };

        // ================================================
        // PARTICLES SETTINGS
        // ================================================
        import { loadParticlesConfig, saveParticlesConfig, defaultParticlesConfig, adjustColorsForTheme } from './public/js/particles-config.js';
        import { getParticlesConfig as getDBConfig, saveParticlesConfigToDB } from './public/js/app.js';

        const loadParticlesSettings = async () => {
            // Load ONLY from database or use default
            const dbResult = await getDBConfig();
            let config;

            if (dbResult.success && dbResult.config) {
                config = dbResult.config;
            } else {
                config = defaultParticlesConfig;
            }

            // Load values into form
            document.getElementById('particlesNumber').value = config.particles.number.value;
            document.getElementById('particlesNumberValue').textContent = config.particles.number.value;

            document.getElementById('particlesColor').value = config.particles.color.value;

            document.getElementById('particlesSpeed').value = config.particles.move.speed;
            document.getElementById('particlesSpeedValue').textContent = config.particles.move.speed;

            document.getElementById('particlesOpacity').value = config.particles.opacity.value;
            document.getElementById('particlesOpacityValue').textContent = config.particles.opacity.value.toFixed(2);

            document.getElementById('lineDistance').value = config.particles.line_linked.distance;
            document.getElementById('lineDistanceValue').textContent = config.particles.line_linked.distance;

            document.getElementById('lineColor').value = config.particles.line_linked.color;

            document.getElementById('lineOpacity').value = config.particles.line_linked.opacity;
            document.getElementById('lineOpacityValue').textContent = config.particles.line_linked.opacity.toFixed(2);

            document.getElementById('hoverEnabled').checked = config.interactivity.events.onhover.enable;
            document.getElementById('hoverEnabledText').textContent = config.interactivity.events.onhover.enable ? 'ActivÃ©' : 'DÃ©sactivÃ©';

            document.getElementById('repulseDistance').value = config.interactivity.modes.repulse.distance;
            document.getElementById('repulseDistanceValue').textContent = config.interactivity.modes.repulse.distance;

            // Load custom blur if exists
            if (config.customBlur !== undefined) {
                document.getElementById('particlesBlur').value = config.customBlur;
                document.getElementById('particlesBlurValue').textContent = config.customBlur + ' px';
                document.getElementById('particles-js').style.filter = `blur(${config.customBlur}px)`;
            }
        };

        const getParticlesConfig = () => {
            const config = JSON.parse(JSON.stringify(defaultParticlesConfig));

            config.particles.number.value = parseInt(document.getElementById('particlesNumber').value);
            config.particles.color.value = document.getElementById('particlesColor').value;
            config.particles.move.speed = parseFloat(document.getElementById('particlesSpeed').value);
            config.particles.opacity.value = parseFloat(document.getElementById('particlesOpacity').value);
            config.particles.line_linked.distance = parseInt(document.getElementById('lineDistance').value);
            config.particles.line_linked.color = document.getElementById('lineColor').value;
            config.particles.line_linked.opacity = parseFloat(document.getElementById('lineOpacity').value);
            config.interactivity.events.onhover.enable = document.getElementById('hoverEnabled').checked;
            config.interactivity.modes.repulse.distance = parseInt(document.getElementById('repulseDistance').value);

            // Add custom blur property (not part of particles.js standard config)
            config.customBlur = parseFloat(document.getElementById('particlesBlur').value);

            return config;
        };

        // Live preview function
        const applyLivePreview = () => {
            let config = getParticlesConfig();
            // Adjust colors for current theme
            config = adjustColorsForTheme(config);

            try {
                const particlesContainer = document.getElementById('particles-js');

                // Destruction sÃ©curisÃ©e avec optional chaining
                if (window.pJSDom && window.pJSDom.length > 0) {
                    try {
                        if (window.pJSDom[0]?.pJS?.fn?.vendors?.destroypJS) {
                            window.pJSDom[0].pJS.fn.vendors.destroypJS();
                        }
                        window.pJSDom = [];
                    } catch (e) {
                        console.warn('Error destroying particles:', e);
                    }
                }

                particlesContainer.innerHTML = '';
                setTimeout(() => {
                    if (window.particlesJS) {
                        window.particlesJS('particles-js', config);
                    }
                }, 20);
            } catch (error) {
                console.error('Live preview error:', error);
            }
        };

        // Range value updates with live preview
        document.getElementById('particlesNumber').addEventListener('input', (e) => {
            document.getElementById('particlesNumberValue').textContent = e.target.value;
            applyLivePreview();
        });
        document.getElementById('particlesColor').addEventListener('input', () => {
            applyLivePreview();
        });
        document.getElementById('particlesSpeed').addEventListener('input', (e) => {
            document.getElementById('particlesSpeedValue').textContent = e.target.value;
            applyLivePreview();
        });
        document.getElementById('particlesOpacity').addEventListener('input', (e) => {
            document.getElementById('particlesOpacityValue').textContent = parseFloat(e.target.value).toFixed(2);
            applyLivePreview();
        });
        document.getElementById('lineDistance').addEventListener('input', (e) => {
            document.getElementById('lineDistanceValue').textContent = e.target.value;
            applyLivePreview();
        });
        document.getElementById('lineColor').addEventListener('input', () => {
            applyLivePreview();
        });
        document.getElementById('lineOpacity').addEventListener('input', (e) => {
            document.getElementById('lineOpacityValue').textContent = parseFloat(e.target.value).toFixed(2);
            applyLivePreview();
        });
        document.getElementById('repulseDistance').addEventListener('input', (e) => {
            document.getElementById('repulseDistanceValue').textContent = e.target.value;
            applyLivePreview();
        });
        document.getElementById('particlesBlur').addEventListener('input', (e) => {
            document.getElementById('particlesBlurValue').textContent = e.target.value + ' px';
            const particlesContainer = document.getElementById('particles-js');
            particlesContainer.style.filter = `blur(${e.target.value}px)`;
        });
        document.getElementById('hoverEnabled').addEventListener('change', (e) => {
            document.getElementById('hoverEnabledText').textContent = e.target.checked ? 'ActivÃ©' : 'DÃ©sactivÃ©';
            applyLivePreview();
        });

        // Save button
        document.getElementById('saveParticlesBtn').addEventListener('click', async () => {
            const config = getParticlesConfig();

            // Save to database only (not localStorage)
            const dbResult = await saveParticlesConfigToDB(config);

            if (dbResult.success) {
                showSuccess('ParamÃ¨tres des particules enregistrÃ©s !');
            } else {
                console.error('DB save error:', dbResult.error);
                showError('Erreur lors de la sauvegarde : ' + dbResult.error);
            }

            // Reload particles
            try {
                const particlesContainer = document.getElementById('particles-js');

                // Destruction sÃ©curisÃ©e avec optional chaining
                if (window.pJSDom && window.pJSDom.length > 0) {
                    try {
                        if (window.pJSDom[0]?.pJS?.fn?.vendors?.destroypJS) {
                            window.pJSDom[0].pJS.fn.vendors.destroypJS();
                        }
                        window.pJSDom = [];
                    } catch (e) {
                        console.warn('Error destroying particles:', e);
                    }
                }

                // Clear the container
                particlesContainer.innerHTML = '';

                // Reinitialize with theme-adjusted colors
                setTimeout(() => {
                    if (window.particlesJS) {
                        const adjustedConfig = adjustColorsForTheme(config);
                        window.particlesJS('particles-js', adjustedConfig);

                        // Apply blur if set
                        if (config.customBlur && config.customBlur > 0) {
                            particlesContainer.style.filter = `blur(${config.customBlur}px)`;
                        }
                    }
                }, 50);
            } catch (error) {
                console.error('Particles reload error:', error);
                showError('Erreur lors du rechargement. Rechargement de la page...');
                setTimeout(() => location.reload(), 1000);
            }
        });

        // Default button - restore default settings
        document.getElementById('resetParticlesBtn').addEventListener('click', async () => {
            // Load default config values into form (moves the sliders)
            document.getElementById('particlesNumber').value = defaultParticlesConfig.particles.number.value;
            document.getElementById('particlesNumberValue').textContent = defaultParticlesConfig.particles.number.value;

            document.getElementById('particlesColor').value = defaultParticlesConfig.particles.color.value;

            document.getElementById('particlesSpeed').value = defaultParticlesConfig.particles.move.speed;
            document.getElementById('particlesSpeedValue').textContent = defaultParticlesConfig.particles.move.speed;

            document.getElementById('particlesOpacity').value = defaultParticlesConfig.particles.opacity.value;
            document.getElementById('particlesOpacityValue').textContent = defaultParticlesConfig.particles.opacity.value.toFixed(2);

            document.getElementById('lineDistance').value = defaultParticlesConfig.particles.line_linked.distance;
            document.getElementById('lineDistanceValue').textContent = defaultParticlesConfig.particles.line_linked.distance;

            document.getElementById('lineColor').value = defaultParticlesConfig.particles.line_linked.color;

            document.getElementById('lineOpacity').value = defaultParticlesConfig.particles.line_linked.opacity;
            document.getElementById('lineOpacityValue').textContent = defaultParticlesConfig.particles.line_linked.opacity.toFixed(2);

            document.getElementById('hoverEnabled').checked = defaultParticlesConfig.interactivity.events.onhover.enable;
            document.getElementById('hoverEnabledText').textContent = defaultParticlesConfig.interactivity.events.onhover.enable ? 'ActivÃ©' : 'DÃ©sactivÃ©';

            document.getElementById('repulseDistance').value = defaultParticlesConfig.interactivity.modes.repulse.distance;
            document.getElementById('repulseDistanceValue').textContent = defaultParticlesConfig.interactivity.modes.repulse.distance;

            // Reset blur to default (0)
            document.getElementById('particlesBlur').value = 0;
            document.getElementById('particlesBlurValue').textContent = '0 px';
            document.getElementById('particles-js').style.filter = 'blur(0px)';

            showSuccess('ParamÃ¨tres par dÃ©faut appliquÃ©s (non enregistrÃ©s)');

            try {
                const particlesContainer = document.getElementById('particles-js');

                // Destruction sÃ©curisÃ©e avec optional chaining
                if (window.pJSDom && window.pJSDom.length > 0) {
                    try {
                        if (window.pJSDom[0]?.pJS?.fn?.vendors?.destroypJS) {
                            window.pJSDom[0].pJS.fn.vendors.destroypJS();
                        }
                        window.pJSDom = [];
                    } catch (e) {
                        console.warn('Error destroying particles:', e);
                    }
                }

                // Clear the container
                particlesContainer.innerHTML = '';

                // Reinitialize with default config (theme-adjusted)
                setTimeout(() => {
                    if (window.particlesJS) {
                        const adjustedDefault = adjustColorsForTheme(defaultParticlesConfig);
                        window.particlesJS('particles-js', adjustedDefault);
                    }
                }, 50);
            } catch (error) {
                console.error('Reset error:', error);
                showError('Erreur lors de la rÃ©initialisation. Rechargement...');
                setTimeout(() => location.reload(), 1000);
            }
        });

        // Initialiser
        (async () => {
            await translatePage();
            await loadProfile();
            await loadUserName();
            await checkAdminAccess();
            await loadSecurityAudit();
            await loadParticlesSettings();

            // ================================================
            // SETTINGS NAVIGATION COLLAPSIBLE - SystÃ¨me universel
            // ================================================

            // SÃ©lectionner tous les headers avec data-collapse-id
            const collapseHeaders = document.querySelectorAll('[data-collapse-id]');

            if (collapseHeaders.length > 0) {
                console.log(`âœ… ${collapseHeaders.length} menu(s) collapse trouvÃ©(s)`);

                collapseHeaders.forEach(header => {
                    const collapseId = header.getAttribute('data-collapse-id');
                    const content = document.querySelector(`[data-collapse-target="${collapseId}"]`);

                    if (!content) {
                        console.warn(`âš ï¸ Contenu collapse non trouvÃ© pour: ${collapseId}`);
                        return;
                    }

                    // Charger l'Ã©tat sauvegardÃ© depuis localStorage
                    const isCollapsed = localStorage.getItem(`collapse_${collapseId}`) === 'true';

                    if (isCollapsed) {
                        header.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }

                    // Event listener pour le toggle
                    header.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const willCollapse = !header.classList.contains('collapsed');

                        // Toggle les classes
                        header.classList.toggle('collapsed');
                        content.classList.toggle('collapsed');

                        // Sauvegarder l'Ã©tat
                        localStorage.setItem(`collapse_${collapseId}`, willCollapse);

                        console.log(`ðŸ”„ Toggle ${collapseId}: ${willCollapse ? 'collapsed' : 'expanded'}`);
                    });
                });
            }

            // ================================================
            // SIDEBAR TOGGLE - Collapsible functionality
            // ================================================
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.dashboard-sidebar');

            // Load saved state from localStorage
            const isSidebarCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
            }

            // Toggle sidebar on button click
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    sidebar.classList.toggle('collapsed');

                    // Save state to localStorage
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebar_collapsed', isCollapsed);

                    console.log(`ðŸ”„ Sidebar ${isCollapsed ? 'collapsed' : 'expanded'}`);
                });
            }
        })();
    </script>
</body>
</html>
