<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres - Newsly AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/css/styles.css">
</head>
<body class="dashboard-body">
    <!-- Navigation Top Bar -->
    <nav class="navbar dashboard-nav">
        <div class="nav-container">
            <a href="dashboard.html" class="logo">
                <img src="https://img.icons8.com/ios-filled/50/000000/news.png" alt="News" class="logo-icon-img">
                <span class="logo-text">Newsly AI</span>
            </a>

            <!-- User Greeting -->
            <div class="nav-user-greeting">
                <span class="greeting-text" id="navGreeting">Bonjour</span>
                <span class="user-role-badge" id="navUserRole">utilisateur</span>
            </div>

            <!-- Weather Widget -->
            <div class="weather-widget" id="weatherWidget">
                <div class="weather-loading">
                    <span>‚òÅÔ∏è</span>
                </div>
            </div>

            <div class="nav-links">
                <!-- Burger Menu -->
                <button class="burger-menu" id="burgerBtn">
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                </button>

                <!-- Burger Dropdown Menu -->
                <div class="burger-dropdown" id="burgerMenu">
                    <div class="burger-user-info">
                        <img id="burgerAvatarImage" class="burger-user-avatar" src="https://ui-avatars.com/api/?name=User&background=3ecf8e&color=fff&size=72" alt="Avatar">
                        <span id="userNameDisplay" class="burger-user-name"></span>
                    </div>

                    <div class="burger-divider"></div>

                    <!-- Theme Toggle avec Switch -->
                    <div class="burger-item">
                        <div class="burger-item-label">
                            <img src="https://img.icons8.com/ios-filled/50/000000/moon-symbol.png" alt="Theme" class="burger-icon">
                            <span id="themeText" data-i18n="nav.darkMode">Mode sombre</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="themeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Language Toggle avec Switch -->
                    <div class="burger-item">
                        <div class="burger-item-label">
                            <img src="https://img.icons8.com/ios-filled/50/000000/globe.png" alt="Language" class="burger-icon">
                            <span id="langLabel">Fran√ßais / English</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="langToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="burger-divider"></div>

                    <button class="burger-link" id="dashboardBtn">
                        <img src="https://img.icons8.com/ios-filled/50/000000/dashboard.png" alt="Dashboard" class="burger-icon">
                        <span data-i18n="nav.dashboard">Dashboard</span>
                    </button>

                    <button class="burger-link" id="logoutBtn">
                        <img src="https://img.icons8.com/ios-filled/50/000000/exit.png" alt="Logout" class="burger-icon">
                        <span data-i18n="nav.logout">D√©connexion</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="settings-layout">
        <!-- Sidebar Navigation -->
        <aside class="settings-nav">
            <h1 class="settings-nav-title">Param√®tres</h1>
            <nav class="settings-nav-menu">
                <button class="settings-nav-item active" data-section="profile">
                    <img src="https://img.icons8.com/ios-filled/50/000000/user.png" alt="Profile" class="settings-nav-icon">
                    <span>Profil</span>
                </button>
                <button class="settings-nav-item" data-section="account">
                    <img src="https://img.icons8.com/ios-filled/50/000000/settings.png" alt="Account" class="settings-nav-icon">
                    <span>Compte</span>
                </button>
                <button class="settings-nav-item" data-section="security">
                    <img src="https://img.icons8.com/ios-filled/50/000000/lock.png" alt="Security" class="settings-nav-icon">
                    <span>S√©curit√©</span>
                </button>
                <button class="settings-nav-item" data-section="users" id="usersNavBtn" style="display: none;">
                    <img src="https://img.icons8.com/ios-filled/50/000000/user-group-man-man.png" alt="Users" class="settings-nav-icon">
                    <span>Utilisateurs</span>
                </button>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="settings-content">
            <!-- Profile Section -->
            <section id="section-profile" class="settings-section active">
                <h2 class="settings-section-title">Profil</h2>
                <p class="settings-section-desc">G√©rez vos informations personnelles</p>

                <div class="settings-card">
            <!-- Avatar Section -->
            <div class="form-group">
                <label class="form-label" data-i18n="settings.avatar">Photo de profil</label>
                <div class="avatar-upload-container">
                    <div class="avatar-preview" id="avatarPreview">
                        <img id="avatarImage" src="https://ui-avatars.com/api/?name=User&background=3ecf8e&color=fff&size=200" alt="Avatar">
                        <div class="avatar-overlay" id="avatarOverlay">
                            <span class="avatar-edit-icon">‚úèÔ∏è</span>
                        </div>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                    <p class="form-hint" data-i18n="settings.avatarHint">Cliquez sur l'avatar pour changer (max 2MB)</p>
                </div>
            </div>

            <div class="form-group">
                <label for="emailDisplay" class="form-label" data-i18n="settings.email">Email</label>
                <input
                    type="email"
                    id="emailDisplay"
                    class="form-input"
                    placeholder="exemple@email.com"
                    disabled
                    readonly
                >
            </div>

            <div class="form-group">
                <label for="usernameInput" class="form-label" data-i18n="settings.username">Nom d'utilisateur</label>
                <input
                    type="text"
                    id="usernameInput"
                    class="form-input"
                    placeholder="MonNomUtilisateur"
                    data-i18n-placeholder="settings.usernamePlaceholder"
                >
            </div>

            <div class="form-group">
                <label for="fullNameInput" class="form-label" data-i18n="settings.fullName">Nom complet</label>
                <input
                    type="text"
                    id="fullNameInput"
                    class="form-input"
                    placeholder="Jean Dupont"
                    data-i18n-placeholder="settings.fullNamePlaceholder"
                >
            </div>

            <div class="form-group">
                <label for="phoneInput" class="form-label" data-i18n="settings.phone">T√©l√©phone</label>
                <input
                    type="tel"
                    id="phoneInput"
                    class="form-input"
                    placeholder="+33 6 12 34 56 78"
                >
            </div>

            <div class="form-group">
                <label for="bioInput" class="form-label" data-i18n="settings.bio">Bio</label>
                <textarea
                    id="bioInput"
                    class="form-input"
                    placeholder="Parlez-nous de vous..."
                    data-i18n-placeholder="settings.bioPlaceholder"
                    rows="3"
                ></textarea>
            </div>

            <button id="updateProfileBtn" class="btn-primary" data-i18n="settings.updateProfile">
                Mettre √† jour le profil
            </button>
        </div>
            </section>

            <!-- Account Section -->
            <section id="section-account" class="settings-section">
                <h2 class="settings-section-title">Compte</h2>
                <p class="settings-section-desc">G√©rez les param√®tres de votre compte</p>

                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label">Pr√©f√©rences de langue</label>
                        <select id="languageSelect" class="form-input">
                            <option value="fr">Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Th√®me</label>
                        <select id="themeSelect" class="form-input">
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                        </select>
                    </div>
                </div>

                <div class="settings-card" style="margin-top: 2rem; border-color: var(--error);">
                    <h3 style="color: var(--error); margin-bottom: 0.5rem;">Zone de danger</h3>
                    <p class="settings-description">
                        Une fois votre compte supprim√©, toutes vos donn√©es seront d√©finitivement effac√©es. Cette action est irr√©versible.
                    </p>
                    <button id="deleteAccountBtn" class="btn-danger">
                        Supprimer mon compte
                    </button>
                </div>
            </section>

            <!-- Security Section -->
            <section id="section-security" class="settings-section">
                <h2 class="settings-section-title">S√©curit√©</h2>
                <p class="settings-section-desc">Prot√©gez votre compte</p>

                <div class="settings-card">

            <div class="form-group">
                <label for="currentPassword" class="form-label" data-i18n="settings.currentPassword">Mot de passe actuel</label>
                <input
                    type="password"
                    id="currentPassword"
                    class="form-input"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    data-i18n-placeholder="settings.currentPasswordPlaceholder"
                >
            </div>

            <div class="form-group">
                <label for="newPassword" class="form-label" data-i18n="settings.newPassword">Nouveau mot de passe</label>
                <input
                    type="password"
                    id="newPassword"
                    class="form-input"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    data-i18n-placeholder="settings.newPasswordPlaceholder"
                >
            </div>

            <div class="form-group">
                <label for="confirmPassword" class="form-label" data-i18n="settings.confirmPassword">Confirmer le mot de passe</label>
                <input
                    type="password"
                    id="confirmPassword"
                    class="form-input"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    data-i18n-placeholder="settings.confirmPasswordPlaceholder"
                >
            </div>

            <button id="changePasswordBtn" class="btn-primary" data-i18n="settings.changePassword">
                Changer le mot de passe
            </button>
        </div>
            </section>

            <!-- Users Management Section (Admin only) -->
            <section id="section-users" class="settings-section">
                <h2 class="settings-section-title">Gestion des utilisateurs</h2>
                <p class="settings-section-desc">G√©rez les utilisateurs et leurs r√¥les</p>

                <div class="settings-card">
                    <div id="usersTableContainer">
                        <!-- Users table will be loaded here -->
                        <p style="text-align: center; color: var(--text-muted);">Chargement des utilisateurs...</p>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-brand">
                        <img src="https://img.icons8.com/ios-filled/50/000000/news.png" alt="News" class="footer-logo-icon">
                        <span>Newsly AI</span>
                    </div>
                    <p class="footer-text">
                        Votre NewsWall personnalis√© aliment√© par l'intelligence artificielle
                    </p>
                </div>

                <div class="footer-section">
                    <h3 class="footer-title">Produit</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="settings.html">Param√®tres</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 class="footer-title">Ressources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Documentation</a></li>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Support</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3 class="footer-title">L√©gal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Confidentialit√©</a></li>
                        <li><a href="#">Conditions</a></li>
                        <li><a href="SECURITY.md">S√©curit√©</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Newsly AI. Tous droits r√©serv√©s.</p>
                <div class="footer-social">
                    <a href="#" aria-label="Twitter"><img src="https://img.icons8.com/ios-filled/50/000000/twitter.png" alt="Twitter"></a>
                    <a href="https://github.com" aria-label="GitHub"><img src="https://img.icons8.com/ios-filled/50/000000/github.png" alt="GitHub"></a>
                    <a href="#" aria-label="LinkedIn"><img src="https://img.icons8.com/ios-filled/50/000000/linkedin.png" alt="LinkedIn"></a>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { checkAuth, getUserProfile, updateUserProfile, changePassword, deleteAccount, logout } from './public/js/app.js';
        import { escapeHtml, showSuccess, showError } from './public/js/dashboard-utils.js';
        import { translatePage } from './public/js/translation-service.js';

        // V√©rifier l'authentification
        const isAuth = checkAuth();
        if (!isAuth) {
            window.location.href = 'index.html';
        }

        // Variable globale pour stocker l'avatar
        let currentAvatarUrl = null;

        // Charger le profil utilisateur
        const loadProfile = async () => {
            const result = await getUserProfile();
            if (result.success) {
                const profile = result.profile;
                const userName = profile.username || profile.email.split('@')[0];
                const userRole = profile.role || 'user';

                // Navbar greeting
                const navGreeting = document.getElementById('navGreeting');
                const navUserRole = document.getElementById('navUserRole');

                if (navGreeting) {
                    navGreeting.textContent = `Bonjour ${escapeHtml(userName)}`;
                }

                if (navUserRole) {
                    if (userRole === 'admin') {
                        navUserRole.textContent = 'Connect√© en tant qu\'admin';
                        navUserRole.className = 'user-role-badge admin';
                    } else {
                        navUserRole.textContent = `Connect√© en tant que ${escapeHtml(userName)}`;
                        navUserRole.className = 'user-role-badge user';
                    }
                }

                // Email (toujours pr√©sent)
                document.getElementById('emailDisplay').value = profile.email;

                // Avatar
                if (profile.avatar_url) {
                    currentAvatarUrl = profile.avatar_url;
                    document.getElementById('avatarImage').src = profile.avatar_url;
                } else {
                    // Avatar par d√©faut avec initiales
                    const name = profile.username || profile.email.split('@')[0];
                    document.getElementById('avatarImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3ecf8e&color=fff&size=200`;
                }

                // Autres champs: ne mettre la valeur que si elle existe (pour garder le placeholder sinon)
                if (profile.username) {
                    document.getElementById('usernameInput').value = profile.username;
                }
                if (profile.full_name) {
                    document.getElementById('fullNameInput').value = profile.full_name;
                }
                if (profile.phone) {
                    document.getElementById('phoneInput').value = profile.phone;
                }
                if (profile.bio) {
                    document.getElementById('bioInput').value = profile.bio;
                }
            }
        };

        // Gestion de l'upload d'avatar
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarInput = document.getElementById('avatarInput');
        const avatarImage = document.getElementById('avatarImage');

        // Cliquer sur l'avatar ouvre le s√©lecteur de fichier
        avatarPreview.addEventListener('click', () => {
            avatarInput.click();
        });

        // Fonction pour compresser l'image
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Redimensionner √† max 200x200 pour limiter la taille
                        const MAX_SIZE = 200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height = Math.round((height * MAX_SIZE) / width);
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width = Math.round((width * MAX_SIZE) / height);
                                height = MAX_SIZE;
                            }
                        }

                        // Cr√©er un canvas pour redimensionner
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convertir en base64 avec compression JPEG (qualit√© 0.8)
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // G√©rer la s√©lection d'image
        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validation: type d'image
            if (!file.type.startsWith('image/')) {
                showError('Veuillez s√©lectionner une image valide');
                return;
            }

            // Validation: taille max 2MB
            const maxSize = 2 * 1024 * 1024; // 2MB en bytes
            if (file.size > maxSize) {
                showError('L\'image ne doit pas d√©passer 2 MB');
                return;
            }

            try {
                // Compresser l'image
                const compressedBase64 = await compressImage(file);

                // Pr√©visualisation locale
                avatarImage.src = compressedBase64;
                currentAvatarUrl = compressedBase64;

                const sizeKB = Math.round((compressedBase64.length * 0.75) / 1024);
                showSuccess(`Image compress√©e (${sizeKB} KB) ! Cliquez sur "Mettre √† jour le profil" pour sauvegarder`);
            } catch (error) {
                showError('Erreur lors de la compression de l\'image');
                console.error(error);
            }
        });

        // Mettre √† jour le profil
        document.getElementById('updateProfileBtn').addEventListener('click', async () => {
            const username = document.getElementById('usernameInput').value.trim();
            const fullName = document.getElementById('fullNameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const bio = document.getElementById('bioInput').value.trim();

            if (!username) {
                showError('Le nom d\'utilisateur ne peut pas √™tre vide');
                return;
            }

            const result = await updateUserProfile({
                username,
                full_name: fullName,
                phone,
                bio,
                avatar_url: currentAvatarUrl
            });

            if (result.success) {
                showSuccess('Profil mis √† jour avec succ√®s !');
                // Mettre √† jour l'avatar dans le burger menu
                if (currentAvatarUrl) {
                    document.getElementById('burgerAvatarImage').src = currentAvatarUrl;
                }
            } else {
                showError(result.error || 'Erreur lors de la mise √† jour');
            }
        });

        // Changer le mot de passe
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                showError('Veuillez remplir le nouveau mot de passe et sa confirmation');
                return;
            }

            if (newPassword.length < 8) {
                showError('Le mot de passe doit contenir au moins 8 caract√®res');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Les mots de passe ne correspondent pas');
                return;
            }

            const result = await changePassword(newPassword);

            if (result.success) {
                showSuccess('Mot de passe chang√© avec succ√®s !');
                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showError(result.error || 'Erreur lors du changement de mot de passe');
            }
        });

        // Supprimer le compte
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer votre compte ? Cette action est irr√©versible !')) {
                if (confirm('üö® DERNI√àRE CONFIRMATION : Toutes vos donn√©es seront perdues. Continuer ?')) {
                    const result = await deleteAccount();
                    if (result.success) {
                        alert('‚úÖ Compte supprim√© avec succ√®s');
                        window.location.href = 'index.html';
                    } else {
                        showError(result.error || 'Erreur lors de la suppression');
                    }
                }
            }
        });

        // G√©rer le burger menu
        const burgerBtn = document.getElementById('burgerBtn');
        const burgerMenu = document.getElementById('burgerMenu');

        // Emp√™cher l'auto-ouverture au chargement
        let burgerInitialized = false;

        burgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            burgerInitialized = true;
            burgerBtn.classList.toggle('active');
            burgerMenu.classList.toggle('show');
        });

        // Fermer le menu si on clique ailleurs (mais seulement si initialis√©)
        document.addEventListener('click', () => {
            if (burgerInitialized) {
                burgerBtn.classList.remove('active');
                burgerMenu.classList.remove('show');
            }
        });

        // Emp√™cher la fermeture si on clique dans le menu
        burgerMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ================================================
        // WEATHER WIDGET
        // ================================================

        const weatherWidget = document.getElementById('weatherWidget');

        const getWeatherIcon = (weatherCode) => {
            // WMO Weather codes: https://open-meteo.com/en/docs
            if (weatherCode === 0) return '‚òÄÔ∏è'; // Clear sky
            if (weatherCode <= 3) return '‚õÖ'; // Partly cloudy
            if (weatherCode <= 48) return 'üå´Ô∏è'; // Fog
            if (weatherCode <= 67) return 'üåßÔ∏è'; // Rain
            if (weatherCode <= 77) return 'üå®Ô∏è'; // Snow
            if (weatherCode <= 82) return 'üåßÔ∏è'; // Showers
            if (weatherCode <= 99) return '‚õàÔ∏è'; // Thunderstorm
            return '‚òÅÔ∏è';
        };

        const fetchWeather = async (lat, lon) => {
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`
                );
                const data = await response.json();

                const temp = Math.round(data.current.temperature_2m);
                const weatherCode = data.current.weather_code;
                const icon = getWeatherIcon(weatherCode);

                // Get city name from reverse geocoding
                const geoResponse = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?latitude=${lat}&longitude=${lon}&count=1&language=fr&format=json`
                );
                const geoData = await geoResponse.json();
                const city = geoData.results?.[0]?.name || 'Inconnu';

                weatherWidget.innerHTML = `
                    <div class="weather-info">
                        <span class="weather-icon">${icon}</span>
                        <div class="weather-details">
                            <span class="weather-temp">${temp}¬∞C</span>
                            <span class="weather-city">${city}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erreur m√©t√©o:', error);
                weatherWidget.innerHTML = `
                    <div class="weather-error">
                        <span>üå°Ô∏è</span>
                    </div>
                `;
            }
        };

        const loadWeather = () => {
            // Check if geolocation is available in localStorage
            const savedLat = localStorage.getItem('weatherLat');
            const savedLon = localStorage.getItem('weatherLon');

            if (savedLat && savedLon) {
                fetchWeather(parseFloat(savedLat), parseFloat(savedLon));
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        localStorage.setItem('weatherLat', lat);
                        localStorage.setItem('weatherLon', lon);
                        fetchWeather(lat, lon);
                    },
                    (error) => {
                        console.log('G√©olocalisation refus√©e, utilisation de Paris par d√©faut');
                        // Paris par d√©faut
                        fetchWeather(48.8566, 2.3522);
                    }
                );
            } else {
                // Paris par d√©faut si pas de g√©olocalisation
                fetchWeather(48.8566, 2.3522);
            }
        };

        // Load weather on page load
        loadWeather();

        // Refresh weather every 10 minutes
        setInterval(loadWeather, 10 * 60 * 1000);

        // G√©rer le toggle du th√®me
        const themeToggle = document.getElementById('themeToggle');
        const themeText = document.getElementById('themeText');

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.checked = savedTheme === 'dark';
        themeText.textContent = savedTheme === 'dark' ? 'Mode sombre' : 'Mode clair';

        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeText.textContent = newTheme === 'dark' ? 'Mode sombre' : 'Mode clair';
        });

        // G√©rer le switch de langue
        const langToggle = document.getElementById('langToggle');
        const savedLang = localStorage.getItem('language') || 'fr';
        langToggle.checked = savedLang === 'en';

        langToggle.addEventListener('change', () => {
            const newLang = langToggle.checked ? 'en' : 'fr';
            localStorage.setItem('language', newLang);
            translatePage();
        });

        // Bouton Dashboard
        document.getElementById('dashboardBtn').addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        // Bouton Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            logout();
        });

        // Charger le nom utilisateur pour le burger
        const loadUserName = async () => {
            const result = await getUserProfile();
            if (result.success) {
                const userName = result.profile.username || result.profile.email.split('@')[0];
                document.getElementById('userNameDisplay').textContent = `Yo! ${escapeHtml(userName)}`;

                // Charger l'avatar dans le burger
                if (result.profile.avatar_url) {
                    document.getElementById('burgerAvatarImage').src = result.profile.avatar_url;
                } else {
                    document.getElementById('burgerAvatarImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=3ecf8e&color=fff&size=72`;
                }
            }
        };

        // ================================================
        // SETTINGS NAVIGATION
        // ================================================

        // Get all navigation items and sections
        const navItems = document.querySelectorAll('.settings-nav-item');
        const sections = document.querySelectorAll('.settings-section');
        const usersNavBtn = document.getElementById('usersNavBtn');
        const usersSection = document.getElementById('section-users');

        // Handle section switching
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = item.dataset.section;

                // Remove active class from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));

                // Add active class to clicked item
                item.classList.add('active');

                // Hide all sections
                sections.forEach(section => section.classList.remove('active'));

                // Show selected section
                const targetSection = document.getElementById(`section-${sectionId}`);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
            });
        });

        // Show/hide Users section based on role
        const checkAdminAccess = async () => {
            const result = await getUserProfile();
            if (result.success && result.profile.role === 'admin') {
                usersNavBtn.style.display = 'flex';

                // Load users list for admin
                loadUsersList();
            }
        };

        // Load users list (admin only)
        const loadUsersList = async () => {
            const usersContainer = document.getElementById('usersTableContainer');

            try {
                // Import Supabase client
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://mauulkejlnlubdzmhirq.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hdXVsa2VqbG5sdWJkem1oaXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5NTQwNzksImV4cCI6MjA2MjUzMDA3OX0.hC0jOBK3rKKj8Fq1P3ITjsZqtaPzzD7EYc7jPVb_Hvs'
                );

                // Fetch all users
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select('id, email, username, role, created_at, last_sign_in_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!users || users.length === 0) {
                    usersContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucun utilisateur trouv√©</p>';
                    return;
                }

                // Create users table
                let tableHTML = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Email</th>
                                <th>R√¥le</th>
                                <th>Derni√®re connexion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                const currentUser = await getUserProfile();
                const currentEmail = currentUser.profile?.email;

                users.forEach(user => {
                    const isCurrentUser = user.email === currentEmail;
                    const isSuperUser = user.email === 'ju.richard.33@gmail.com';
                    const displayName = user.username || user.email.split('@')[0];
                    const lastSignIn = user.last_sign_in_at
                        ? new Date(user.last_sign_in_at).toLocaleDateString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          })
                        : 'Jamais';

                    tableHTML += `
                        <tr>
                            <td><strong>${escapeHtml(displayName)}</strong></td>
                            <td>${escapeHtml(user.email)}</td>
                            <td>
                                <span class="role-badge ${user.role}">${user.role}</span>
                            </td>
                            <td>${lastSignIn}</td>
                            <td>
                                ${!isSuperUser ? `
                                    <button class="btn-role-toggle" data-user-id="${user.id}" data-current-role="${user.role}" ${isCurrentUser ? 'disabled' : ''}>
                                        Changer r√¥le
                                    </button>
                                ` : '<span style="color: var(--text-muted); font-size: 0.875rem;">Super Admin</span>'}
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                usersContainer.innerHTML = tableHTML;

                // Add event listeners for role toggle buttons
                document.querySelectorAll('.btn-role-toggle').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const userId = btn.dataset.userId;
                        const currentRole = btn.dataset.currentRole;
                        const newRole = currentRole === 'admin' ? 'user' : 'admin';

                        if (confirm(`Changer le r√¥le vers "${newRole}" ?`)) {
                            try {
                                const { error } = await supabase
                                    .from('profiles')
                                    .update({ role: newRole })
                                    .eq('id', userId);

                                if (error) throw error;

                                showSuccess('R√¥le mis √† jour avec succ√®s');
                                loadUsersList(); // Reload the list
                            } catch (error) {
                                showError('Erreur lors du changement de r√¥le');
                                console.error(error);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                usersContainer.innerHTML = '<p style="text-align: center; color: var(--error);">Erreur lors du chargement des utilisateurs</p>';
            }
        };

        // Initialiser
        (async () => {
            await translatePage();
            await loadProfile();
            await loadUserName();
            await checkAdminAccess();
        })();
    </script>
</body>
</html>
