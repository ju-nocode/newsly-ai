<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Newsly AI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard-body">
    <!-- Navigation Top Bar -->
    <nav class="navbar dashboard-nav">
        <div class="nav-container">
            <div class="nav-links">
                <span id="userNameDisplay" class="user-name"></span>
                <button id="logoutBtn" class="btn-secondary">D√©connexion</button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <h2>üì∞ Newsly AI</h2>
            <button id="refreshNewsBtn" class="btn-icon" title="Rafra√Æchir">üîÑ</button>
        </div>

        <div class="sidebar-header">
            <button id="toggle-btn">‚ò∞</button>
            <button id="pin-btn">üìå</button>
        </div>
        
        <!-- Search Bar Section -->
        <div class="sidebar-search-section">
            <div class="sidebar-search">
                <input 
                    type="text" 
                    class="search-input" 
                    id="topicSearch"
                    placeholder="Rechercher un topic..." 
                    autocomplete="off"
                >
                <span class="search-icon">üîç</span>
                
                <!-- Search Results Dropdown -->
                <div class="search-results" id="searchResults">
                    <!-- R√©sultats dynamiques -->
                </div>
            </div>
        </div>

        <div class="categories-list">
            <label class="category-toggle">
                <input type="checkbox" class="category-checkbox" data-category="ai" checked>
                <span class="category-label">
                    <span class="category-icon">ü§ñ</span>
                    <span>Intelligence Artificielle</span>
                </span>
            </label>

            <label class="category-toggle">
                <input type="checkbox" class="category-checkbox" data-category="world" checked>
                <span class="category-label">
                    <span class="category-icon">üåç</span>
                    <span>Actualit√©s Mondiales</span>
                </span>
            </label>

            <label class="category-toggle">
                <input type="checkbox" class="category-checkbox" data-category="finance" checked>
                <span class="category-label">
                    <span class="category-icon">üíπ</span>
                    <span>Finance</span>
                </span>
            </label>

            <label class="category-toggle">
                <input type="checkbox" class="category-checkbox" data-category="science" checked>
                <span class="category-label">
                    <span class="category-icon">üî¨</span>
                    <span>Science</span>
                </span>
            </label>
        </div>

        <div class="sidebar-footer">
            <p class="sidebar-info">üí° Activez/d√©sactivez les cat√©gories pour personnaliser votre NewsWall</p>
        </div>
    </aside>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1 id="welcomeTitle">Bienvenue sur votre NewsWall üéØ</h1>
                <p class="dashboard-subtitle">Actualit√©s en temps r√©el personnalis√©es par IA</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="loader-big"></div>
                <p>Chargement de vos actualit√©s...</p>
            </div>

            <!-- News Grid -->
            <div id="newsGrid" class="news-grid" style="display: none;">
                <!-- AI Category -->
                <div class="news-category" id="ai-category" data-category="ai">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">ü§ñ</span>
                            <h2 class="category-title">Intelligence Artificielle</h2>
                        </div>
                    </div>
                    <div class="news-items" id="ai-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- World Category -->
                <div class="news-category" id="world-category" data-category="world">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üåç</span>
                            <h2 class="category-title">Actualit√©s Mondiales</h2>
                        </div>
                    </div>
                    <div class="news-items" id="world-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- Finance Category -->
                <div class="news-category" id="finance-category" data-category="finance">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üíπ</span>
                            <h2 class="category-title">Finance</h2>
                        </div>
                    </div>
                    <div class="news-items" id="finance-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- Science Category -->
                <div class="news-category" id="science-category" data-category="science">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üî¨</span>
                            <h2 class="category-title">Science</h2>
                        </div>
                    </div>
                    <div class="news-items" id="science-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üì≠</div>
                <h2>Aucune cat√©gorie s√©lectionn√©e</h2>
                <p>Activez au moins une cat√©gorie dans la barre lat√©rale pour voir les actualit√©s</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { supabase, loadUserProfile, loadUserPreferences, saveUserPreferences, fetchNewsForCategory, displayNews } from './app.js';

        let currentUser = null;
        let userPreferences = {};
        let searchTimeout = null;

        // Liste des topics sugg√©r√©s
        const availableTopics = [
            { id: 'ai', icon: 'ü§ñ', title: 'Intelligence Artificielle', desc: 'IA, ML, Deep Learning' },
            { id: 'blockchain', icon: '‚õìÔ∏è', title: 'Blockchain', desc: 'Crypto, Web3, NFT' },
            { id: 'climate', icon: 'üå°Ô∏è', title: 'Climat', desc: 'Environnement, √âcologie' },
            { id: 'space', icon: 'üöÄ', title: 'Espace', desc: 'Astronomie, NASA, SpaceX' },
            { id: 'health', icon: 'üè•', title: 'Sant√©', desc: 'M√©decine, Biotechnologie' },
            { id: 'tech', icon: 'üíª', title: 'Technologie', desc: 'Startups, Innovation' },
            { id: 'gaming', icon: 'üéÆ', title: 'Gaming', desc: 'Jeux vid√©o, Esports' },
            { id: 'sports', icon: '‚öΩ', title: 'Sports', desc: 'Football, Basketball, Tennis' },
            { id: 'politics', icon: 'üèõÔ∏è', title: 'Politique', desc: 'Gouvernements, √âlections' },
            { id: 'economy', icon: 'üìä', title: '√âconomie', desc: 'March√©s, Trading' }
        ];

        // Search functionality
        const searchInput = document.getElementById('topicSearch');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                searchResults.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(() => {
                const filtered = availableTopics.filter(topic => 
                    topic.title.toLowerCase().includes(query) ||
                    topic.desc.toLowerCase().includes(query)
                );

                displaySearchResults(filtered, query);
            }, 300);
        });

        function displaySearchResults(results, query) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-empty">Aucun topic trouv√© pour "' + query + '"</div>';
                searchResults.classList.add('active');
                return;
            }

            searchResults.innerHTML = results.map(topic => `
                <div class="search-result-item" data-topic="${topic.id}">
                    <span class="search-result-icon">${topic.icon}</span>
                    <div class="search-result-text">
                        <div class="search-result-title">${topic.title}</div>
                        <div class="search-result-desc">${topic.desc}</div>
                    </div>
                </div>
            `).join('');

            searchResults.classList.add('active');

            // Ajouter les event listeners sur les r√©sultats
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const topicId = item.dataset.topic;
                    await addTopicCategory(topicId);
                    searchInput.value = '';
                    searchResults.classList.remove('active');
                });
            });
        }

        // Fermer les r√©sultats quand on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // Ajouter une nouvelle cat√©gorie de topic
        async function addTopicCategory(topicId) {
            const topic = availableTopics.find(t => t.id === topicId);
            if (!topic) return;

            // V√©rifier si la cat√©gorie existe d√©j√†
            if (document.querySelector(`[data-category="${topicId}"]`)) {
                alert('Cette cat√©gorie est d√©j√† ajout√©e !');
                return;
            }

            // Ajouter la checkbox dans la sidebar
            const categoriesList = document.querySelector('.categories-list');
            const newCategory = document.createElement('label');
            newCategory.className = 'category-toggle';
            newCategory.innerHTML = `
                <input type="checkbox" class="category-checkbox" data-category="${topicId}" checked>
                <span class="category-label">
                    <span class="category-icon">${topic.icon}</span>
                    <span>${topic.title}</span>
                </span>
            `;
            categoriesList.appendChild(newCategory);

            // Ajouter la carte de news dans la grille
            const newsGrid = document.getElementById('newsGrid');
            const newNewsCategory = document.createElement('div');
            newNewsCategory.className = 'news-category';
            newNewsCategory.id = `${topicId}-category`;
            newNewsCategory.dataset.category = topicId;
            newNewsCategory.innerHTML = `
                <div class="category-header">
                    <div class="category-title-group">
                        <span class="category-icon">${topic.icon}</span>
                        <h2 class="category-title">${topic.title}</h2>
                    </div>
                </div>
                <div class="news-items" id="${topicId}-news">
                    <div class="loading">Chargement...</div>
                </div>
            `;
            newsGrid.appendChild(newNewsCategory);

            // Charger les news pour ce topic
            const articles = await fetchNewsForCategory(topicId);
            displayNews(`${topicId}-news`, articles);

            // Sauvegarder la pr√©f√©rence
            userPreferences[topicId] = true;
            await saveUserPreferences(currentUser.id, topicId, true);

            // Ajouter l'event listener pour la nouvelle checkbox
            const checkbox = newCategory.querySelector('.category-checkbox');
            checkbox.addEventListener('change', async (e) => {
                const category = e.target.dataset.category;
                const isActive = e.target.checked;
                
                userPreferences[category] = isActive;
                await saveUserPreferences(currentUser.id, category, isActive);
                
                updateNewsGridVisibility();

                if (isActive) {
                    const articles = await fetchNewsForCategory(category);
                    displayNews(`${category}-news`, articles);
                }
            });
        }

        // V√©rifier l'authentification
        const checkAuth = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            await initDashboard();
        };

        // Initialiser le dashboard
        const initDashboard = async () => {
            const profile = await loadUserProfile(currentUser.id);
            
            if (profile) {
                document.getElementById('userNameDisplay').textContent = profile.full_name || profile.email;
                document.getElementById('welcomeTitle').textContent = `Bienvenue ${profile.full_name || ''} üëã`;
            }

            userPreferences = await loadUserPreferences(currentUser.id);
            updateCheckboxes();
            await loadAllNews();

            document.getElementById('loadingState').style.display = 'none';
            updateNewsGridVisibility();
        };

        const updateCheckboxes = () => {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                const category = checkbox.dataset.category;
                checkbox.checked = userPreferences[category] !== false;
            });
        };

        const loadAllNews = async () => {
            const categories = ['ai', 'world', 'finance', 'science'];
            
            for (const category of categories) {
                if (userPreferences[category] !== false) {
                    const articles = await fetchNewsForCategory(category);
                    displayNews(`${category}-news`, articles);
                }
            }
        };

        const updateNewsGridVisibility = () => {
            const anyActive = Object.values(userPreferences).some(val => val !== false);
            
            if (anyActive) {
                document.getElementById('newsGrid').style.display = 'grid';
                document.getElementById('emptyState').style.display = 'none';
            } else {
                document.getElementById('newsGrid').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
            }

            document.querySelectorAll('.news-category').forEach(cat => {
                const category = cat.dataset.category;
                cat.style.display = userPreferences[category] !== false ? 'block' : 'none';
            });
        };

        // G√©rer les changements de cat√©gorie
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
                const category = e.target.dataset.category;
                const isActive = e.target.checked;
                
                userPreferences[category] = isActive;
                await saveUserPreferences(currentUser.id, category, isActive);
                
                updateNewsGridVisibility();

                if (isActive) {
                    const articles = await fetchNewsForCategory(category);
                    displayNews(`${category}-news`, articles);
                }
            });
        });

        // Bouton rafra√Æchir
        document.getElementById('refreshNewsBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshNewsBtn');
            btn.style.transform = 'rotate(360deg)';
            await loadAllNews();
            setTimeout(() => {
                btn.style.transform = 'rotate(0deg)';
            }, 500);
        });

        // Bouton d√©connexion
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });

        // Initialiser
        checkAuth();
    </script>
    <script>
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggle-btn');
  const pinBtn = document.getElementById('pin-btn');
  
  let isPinned = false;

  toggleBtn.addEventListener('click', () => {
    if (!isPinned) {
      sidebar.classList.toggle('collapsed');
    }
  });

  pinBtn.addEventListener('click', () => {
    isPinned = !isPinned;
    pinBtn.textContent = isPinned ? "üìç" : "üìå"; // Change l‚Äôic√¥ne
  });
</script>

</body>
</html>
