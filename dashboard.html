<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Newsly AI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard-body">
    <!-- Navigation Dashboard -->
    <nav class="navbar dashboard-nav">
        <div class="nav-container">
            <a href="dashboard.html" class="logo">
                <span class="logo-icon">üì∞</span>
                <span class="logo-text">Newsly AI</span>
            </a>
            <div class="nav-links">
                <span id="userNameDisplay" class="user-name"></span>
                <button id="logoutBtn" class="btn-secondary">D√©connexion</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <h2>Vos Cat√©gories</h2>
                <button id="refreshNewsBtn" class="btn-icon" title="Rafra√Æchir">üîÑ</button>
            </div>

            <div class="categories-list">
                <label class="category-toggle">
                    <input type="checkbox" class="category-checkbox" data-category="ai" checked>
                    <span class="category-label">
                        <span class="category-icon">ü§ñ</span>
                        <span>Intelligence Artificielle</span>
                    </span>
                </label>

                <label class="category-toggle">
                    <input type="checkbox" class="category-checkbox" data-category="world" checked>
                    <span class="category-label">
                        <span class="category-icon">üåç</span>
                        <span>Actualit√©s Mondiales</span>
                    </span>
                </label>

                <label class="category-toggle">
                    <input type="checkbox" class="category-checkbox" data-category="finance" checked>
                    <span class="category-label">
                        <span class="category-icon">üíπ</span>
                        <span>Finance</span>
                    </span>
                </label>

                <label class="category-toggle">
                    <input type="checkbox" class="category-checkbox" data-category="science" checked>
                    <span class="category-label">
                        <span class="category-icon">üî¨</span>
                        <span>Science</span>
                    </span>
                </label>
            </div>

            <div class="sidebar-footer">
                <p class="sidebar-info">üí° Activez/d√©sactivez les cat√©gories pour personnaliser votre NewsWall</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1 id="welcomeTitle">Bienvenue sur votre NewsWall üéØ</h1>
                <p class="dashboard-subtitle">Actualit√©s en temps r√©el personnalis√©es par IA</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="loader-big"></div>
                <p>Chargement de vos actualit√©s...</p>
            </div>

            <!-- News Grid -->
            <div id="newsGrid" class="news-grid" style="display: none;">
                <!-- AI Category -->
                <div class="news-category" id="ai-category" data-category="ai">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">ü§ñ</span>
                            <h2 class="category-title">Intelligence Artificielle</h2>
                        </div>
                    </div>
                    <div class="news-items" id="ai-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- World Category -->
                <div class="news-category" id="world-category" data-category="world">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üåç</span>
                            <h2 class="category-title">Actualit√©s Mondiales</h2>
                        </div>
                    </div>
                    <div class="news-items" id="world-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- Finance Category -->
                <div class="news-category" id="finance-category" data-category="finance">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üíπ</span>
                            <h2 class="category-title">Finance</h2>
                        </div>
                    </div>
                    <div class="news-items" id="finance-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>

                <!-- Science Category -->
                <div class="news-category" id="science-category" data-category="science">
                    <div class="category-header">
                        <div class="category-title-group">
                            <span class="category-icon">üî¨</span>
                            <h2 class="category-title">Science</h2>
                        </div>
                    </div>
                    <div class="news-items" id="science-news">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üì≠</div>
                <h2>Aucune cat√©gorie s√©lectionn√©e</h2>
                <p>Activez au moins une cat√©gorie dans la barre lat√©rale pour voir les actualit√©s</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { supabase, loadUserProfile, loadUserPreferences, saveUserPreferences, fetchNewsForCategory, displayNews } from './app.js';

        let currentUser = null;
        let userPreferences = {};

        // V√©rifier l'authentification
        const checkAuth = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            await initDashboard();
        };

        // Initialiser le dashboard
        const initDashboard = async () => {
            // Charger le profil utilisateur
            const profile = await loadUserProfile(currentUser.id);
            
            if (profile) {
                document.getElementById('userNameDisplay').textContent = profile.full_name || profile.email;
                document.getElementById('welcomeTitle').textContent = `Bienvenue ${profile.full_name || ''} üëã`;
            }

            // Charger les pr√©f√©rences
            userPreferences = await loadUserPreferences(currentUser.id);
            
            // Mettre √† jour les checkboxes selon les pr√©f√©rences
            updateCheckboxes();

            // Charger les actualit√©s
            await loadAllNews();

            // Cacher le loading et afficher le contenu
            document.getElementById('loadingState').style.display = 'none';
            updateNewsGridVisibility();
        };

        // Mettre √† jour les checkboxes selon les pr√©f√©rences
        const updateCheckboxes = () => {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                const category = checkbox.dataset.category;
                checkbox.checked = userPreferences[category] !== false;
            });
        };

        // Charger toutes les actualit√©s
        const loadAllNews = async () => {
            const categories = ['ai', 'world', 'finance', 'science'];
            
            for (const category of categories) {
                if (userPreferences[category] !== false) {
                    const articles = await fetchNewsForCategory(category);
                    displayNews(`${category}-news`, articles);
                }
            }
        };

        // Mettre √† jour la visibilit√© de la grille
        const updateNewsGridVisibility = () => {
            const anyActive = Object.values(userPreferences).some(val => val !== false);
            
            if (anyActive) {
                document.getElementById('newsGrid').style.display = 'grid';
                document.getElementById('emptyState').style.display = 'none';
            } else {
                document.getElementById('newsGrid').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
            }

            // Afficher/cacher les cat√©gories selon les pr√©f√©rences
            document.querySelectorAll('.news-category').forEach(cat => {
                const category = cat.dataset.category;
                cat.style.display = userPreferences[category] !== false ? 'block' : 'none';
            });
        };

        // G√©rer les changements de cat√©gorie
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
                const category = e.target.dataset.category;
                const isActive = e.target.checked;
                
                userPreferences[category] = isActive;
                await saveUserPreferences(currentUser.id, category, isActive);
                
                updateNewsGridVisibility();

                // Recharger les news pour cette cat√©gorie si activ√©e
                if (isActive) {
                    const articles = await fetchNewsForCategory(category);
                    displayNews(`${category}-news`, articles);
                }
            });
        });

        // Bouton rafra√Æchir
        document.getElementById('refreshNewsBtn').addEventListener('click', async () => {
            document.getElementById('refreshNewsBtn').style.transform = 'rotate(360deg)';
            await loadAllNews();
            setTimeout(() => {
                document.getElementById('refreshNewsBtn').style.transform = 'rotate(0deg)';
            }, 500);
        });

        // Bouton d√©connexion
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });

        // Initialiser
        checkAuth();
    </script>
</body>
</html>
