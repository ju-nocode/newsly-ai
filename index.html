<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsly AI - Votre NewsWall Personnalis√© Aliment√© par IA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/css/dashboard-main.css">
    <script src="public/js/browser-detect.js"></script>
    <script src="public/js/icons-theme.js"></script>
</head>
<body class="dashboard-body">

    <!-- Overlay pour menu mobile -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Public Banner (only shown for non-authenticated users) -->
    <div class="public-banner" id="publicBanner" style="display: none;">
        <div class="public-banner-text">
            Connectez-vous pour personnaliser vos actualit√©s et sauvegarder vos pr√©f√©rences
        </div>
        <div class="public-banner-buttons">
            <button class="public-banner-btn" id="publicLoginBtn">Connexion</button>
            <button class="public-banner-btn secondary" id="publicSignupBtn">Cr√©er un compte</button>
        </div>
    </div>

    <!-- Navbar will be injected here by navbar-component.js -->

    <!-- Vertical Sidebar - With locked overlay for public mode -->
    <aside class="vertical-sidebar" id="verticalSidebar">
        <!-- Locked overlay for public users -->
        <div class="sidebar-locked-overlay" id="sidebarLockedOverlay" style="display: none;">
            <div class="sidebar-locked-message">
                <p>Connectez-vous pour acc√©der aux filtres</p>
                <button class="public-banner-btn" id="sidebarLoginBtn">Connexion</button>
            </div>
        </div>

        <div class="sidebar-content">
            <!-- Cat√©gories -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title" data-i18n="sidebar.categories">Cat√©gories</h3>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link active" href="#" data-category="general" data-tooltip="G√©n√©ral">
                            <img src="https://img.icons8.com/ios-filled/18/news.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.general">G√©n√©ral</span>
                        </a>
                        <button class="pin-btn" data-pin-category="general" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="business" data-tooltip="Business">
                            <img src="https://img.icons8.com/ios-filled/18/briefcase.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.business">Business</span>
                        </a>
                        <button class="pin-btn" data-pin-category="business" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="technology" data-tooltip="Technologie">
                            <img src="https://img.icons8.com/ios-filled/18/laptop.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.technology">Technologie</span>
                        </a>
                        <button class="pin-btn" data-pin-category="technology" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="science" data-tooltip="Science">
                            <img src="https://img.icons8.com/ios-filled/18/test-tube.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.science">Science</span>
                        </a>
                        <button class="pin-btn" data-pin-category="science" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="health" data-tooltip="Sant√©">
                            <img src="https://img.icons8.com/ios-filled/18/heart-with-pulse.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.health">Sant√©</span>
                        </a>
                        <button class="pin-btn" data-pin-category="health" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="sports" data-tooltip="Sports">
                            <img src="https://img.icons8.com/ios-filled/18/football.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.sports">Sports</span>
                        </a>
                        <button class="pin-btn" data-pin-category="sports" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-category="entertainment" data-tooltip="Divertissement">
                            <img src="https://img.icons8.com/ios-filled/18/clapperboard.png" alt="" class="sidebar-icon">
                            <span data-i18n="category.entertainment">Divertissement</span>
                        </a>
                        <button class="pin-btn" data-pin-category="entertainment" aria-label="Pin category">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Pays -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title" data-i18n="sidebar.countries">Pays</h3>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link active" href="#" data-country="us" data-tooltip="√âtats-Unis">
                            <img src="https://img.icons8.com/color/18/usa.png" alt="" class="sidebar-icon">
                            <span data-i18n="country.us">√âtats-Unis</span>
                        </a>
                        <button class="pin-btn" data-pin-country="us" aria-label="Pin country">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-country="fr" data-tooltip="France">
                            <img src="https://img.icons8.com/color/18/france.png" alt="" class="sidebar-icon">
                            <span data-i18n="country.fr">France</span>
                        </a>
                        <button class="pin-btn" data-pin-country="fr" aria-label="Pin country">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-country="gb" data-tooltip="Royaume-Uni">
                            <img src="https://img.icons8.com/color/18/great-britain.png" alt="" class="sidebar-icon">
                            <span data-i18n="country.gb">Royaume-Uni</span>
                        </a>
                        <button class="pin-btn" data-pin-country="gb" aria-label="Pin country">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-country="ca" data-tooltip="Canada">
                            <img src="https://img.icons8.com/color/18/canada.png" alt="" class="sidebar-icon">
                            <span data-i18n="country.ca">Canada</span>
                        </a>
                        <button class="pin-btn" data-pin-country="ca" aria-label="Pin country">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <a class="sidebar-menu-link" href="#" data-country="de" data-tooltip="Allemagne">
                            <img src="https://img.icons8.com/color/18/germany.png" alt="" class="sidebar-icon">
                            <span data-i18n="country.de">Allemagne</span>
                        </a>
                        <button class="pin-btn" data-pin-country="de" aria-label="Pin country">
                            <img src="https://img.icons8.com/ios/16/pin3.png" alt="Pin" class="pin-icon">
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="dashboard-container">
        <main class="dashboard-main">
            <div class="news-header">
                <h1 id="categoryTitle">Actualit√©s G√©n√©rales</h1>
                <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                    Chargement...
                </div>
            </div>

            <div id="newsContainer" class="news-grid">
                <!-- Les actualit√©s seront charg√©es ici -->
            </div>
        </main>
    </div>

    <!-- Auth Modal (simple login/signup) -->
    <div class="modal-overlay" id="authModal" style="display: none;">
        <div class="modal-container">
            <button class="modal-close" id="closeModal">&times;</button>

            <!-- Login Form -->
            <div class="modal-content" id="loginForm">
                <h2 class="modal-title" data-i18n="auth.loginTitle">Connexion</h2>
                <p class="modal-subtitle" data-i18n="auth.loginSubtitle">Connectez-vous √† votre compte</p>

                <form class="auth-form" id="loginFormElement">
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.email">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.password">Mot de passe</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn btn-submit" data-i18n="auth.loginBtn">Se connecter</button>
                </form>

                <p class="modal-footer">
                    <span data-i18n="auth.noAccount">Pas de compte ?</span> <a href="#" id="switchToSignup" data-i18n="auth.createAccount">Cr√©er un compte</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div class="modal-content" id="signupForm" style="display: none;">
                <h2 class="modal-title">Cr√©er un compte</h2>
                <p class="modal-subtitle">Rejoignez Newsly AI</p>

                <form class="auth-form" id="signupFormElement">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="signupPassword" required>
                    </div>
                    <div id="signupError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn btn-submit">Cr√©er mon compte</button>
                </form>

                <p class="modal-footer">
                    <span>D√©j√† un compte ?</span> <a href="#" id="switchToLogin">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { checkAuth, login, logout } from './public/js/app.js';
        import { displayNews, escapeHtml, showError, showSuccess } from './public/js/dashboard-utils.js';
        import { translatePage } from './public/js/translation-service.js';
        import { initNavbar } from './public/js/navbar-component.js';
        import { initThemeSystem } from './public/js/theme-manager.js';
        import { showPageLoader, hidePageLoader } from './public/js/page-loader.js';
        import { showShimmerLoader, hideShimmerLoader } from './public/js/shimmer-loader.js';

        const publicBanner = document.getElementById('publicBanner');
        const newsContainer = document.getElementById('newsContainer');
        const authModal = document.getElementById('authModal');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const sidebarLockedOverlay = document.getElementById('sidebarLockedOverlay');

        // Smart redirect and public mode initialization
        (async () => {
            showPageLoader();

            try {
                // Check authentication status
                const isAuthenticated = checkAuth();

                if (isAuthenticated) {
                    // ‚úÖ AUTHENTICATED ‚Üí Redirect to full dashboard
                    console.log('‚úÖ User authenticated ‚Üí Redirecting to dashboard.html');
                    window.location.href = 'dashboard.html';
                    return;
                }

                // ‚ùå NOT AUTHENTICATED ‚Üí Public mode
                console.log('üìñ Public mode enabled');

                // Initialize navbar in public mode (no settings, no user profile)
                initNavbar('div.mobile-overlay', {
                    showMobileSidebarBtn: false,
                    showSettingsNav: false,
                    publicMode: true
                });

                // Initialize theme system
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        initThemeSystem();
                    });
                });

                // Show public banner
                publicBanner.style.display = 'flex';

                // Show locked overlay on sidebar
                sidebarLockedOverlay.style.display = 'flex';

                // Translate page
                await translatePage();

                // Load public news (general category, US country)
                showShimmerLoader(newsContainer, 6);

                const response = await fetch('/api/news/public?category=general&country=us&page=1');
                if (!response.ok) throw new Error('Failed to load public news');

                const data = await response.json();

                hideShimmerLoader(newsContainer);

                if (data.success && data.articles && data.articles.length > 0) {
                    displayNews(data.articles, 'newsContainer');
                    hidePageLoader(false);
                } else {
                    newsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucune actualit√© disponible</p>';
                    hidePageLoader(true);
                }

            } catch (error) {
                console.error('‚ùå Error loading public dashboard:', error);
                hideShimmerLoader(newsContainer);
                hidePageLoader(true);
                showError('Erreur lors du chargement des actualit√©s');
            }
        })();

        // Public banner buttons
        document.getElementById('publicLoginBtn').addEventListener('click', () => {
            authModal.style.display = 'flex';
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        });

        document.getElementById('publicSignupBtn').addEventListener('click', () => {
            authModal.style.display = 'flex';
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        document.getElementById('sidebarLoginBtn').addEventListener('click', () => {
            authModal.style.display = 'flex';
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        });

        // Modal close button
        document.getElementById('closeModal').addEventListener('click', () => {
            authModal.style.display = 'none';
        });

        // Switch between login and signup
        document.getElementById('switchToSignup').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        document.getElementById('switchToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        // Login form submission
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const loginError = document.getElementById('loginError');
            loginError.style.display = 'none';

            try {
                const result = await login(email, password);
                if (result.success) {
                    showSuccess('Connexion r√©ussie !');
                    window.location.href = 'dashboard.html';
                } else {
                    loginError.textContent = result.error || 'Erreur de connexion';
                    loginError.style.display = 'block';
                }
            } catch (error) {
                loginError.textContent = 'Une erreur est survenue';
                loginError.style.display = 'block';
            }
        });

        // Signup form submission - For now, disable and show message
        document.getElementById('signupFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            const signupError = document.getElementById('signupError');
            signupError.textContent = 'Veuillez vous connecter avec un compte existant. L\'inscription sera bient√¥t disponible.';
            signupError.style.display = 'block';
        });

        // Close modal on outside click
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
